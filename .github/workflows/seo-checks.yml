name: "ðŸ”Ž SEO Checks (Ahrefs v3)"

on:
  schedule:
    - cron: "12 3 * * *"   # 03:12 UTC quotidien
  workflow_dispatch: {}

env:
  TPS_DOMAIN: ${{ secrets.TPS_DOMAIN }}               # ex: https://thepetsociety.paris
  AHREFS_API_KEY: ${{ secrets.AHREFS_API_KEY }}       # Token Ahrefs v3
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # optionnel

jobs:
  seo:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”§ Ensure jq is available
        run: |
          set -e
          command -v jq >/dev/null || { sudo apt-get update -y && sudo apt-get install -y jq; }
          jq --version

      - name: ðŸ“¥ Fetch Ahrefs v3 metrics
        id: ahrefs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out

          [[ -n "${AHREFS_API_KEY:-}" ]] || { echo "âŒ AHREFS_API_KEY manquant"; exit 1; }
          [[ -n "${TPS_DOMAIN:-}"     ]] || { echo "âŒ TPS_DOMAIN manquant";     exit 1; }

          # Normalise le domaine (retire https://, http:// et le path)
          TARGET="${TPS_DOMAIN#http://}"; TARGET="${TARGET#https://}"; TARGET="${TARGET%%/*}"
          echo "ðŸŽ¯ Target: $TARGET"

          # Appel API v3
          HTTP_CODE=$(curl -sS -w "%{http_code}" -o out/ahrefs_metrics.json \
            -H "Authorization: Bearer ${AHREFS_API_KEY}" \
            "https://api.ahrefs.com/v3/site-explorer/metrics?target=${TARGET}&mode=domain")

          echo "http_code=${HTTP_CODE}" >> "$GITHUB_OUTPUT"

          # Extraction tolÃ©rante des mÃ©triques (si prÃ©sentes)
          DR=$(jq -r '..|objects|to_entries[]?|select(.key=="domain_rating")|.value' out/ahrefs_metrics.json | head -n1 || true)
          BL=$(jq -r '..|objects|to_entries[]?|select(.key=="backlinks")|.value'      out/ahrefs_metrics.json | head -n1 || true)
          RD=$(jq -r '..|objects|to_entries[]?|select(.key=="ref_domains")|.value'    out/ahrefs_metrics.json | head -n1 || true)

          DR=${DR:-n/a}; BL=${BL:-n/a}; RD=${RD:-n/a}

          # CSV rapide
          echo "domain,rating,backlinks,ref_domains" > out/ahrefs_metrics.csv
          echo "${TARGET},${DR},${BL},${RD}"        >> out/ahrefs_metrics.csv

          # Expose outputs
          {
            echo "target=${TARGET}"
            echo "dr=${DR}"
            echo "bl=${BL}"
            echo "rd=${RD}"
          } >> "$GITHUB_OUTPUT"

      - name: ðŸ“¦ Upload artefacts (JSON/CSV)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: seo-ahrefs
          path: out/
          retention-days: 7
          if-no-files-found: warn

      - name: ðŸ’¬ Slack (rÃ©sumÃ©)
        if: ${{ always() && env.SLACK_WEBHOOK_URL != '' }}
        env:
          URL_RUN: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TARGET: ${{ steps.ahrefs.outputs.target }}
          DR:     ${{ steps.ahrefs.outputs.dr }}
          BL:     ${{ steps.ahrefs.outputs.bl }}
          RD:     ${{ steps.ahrefs.outputs.rd }}
          CODE:   ${{ steps.ahrefs.outputs.http_code }}
        run: |
          set -euo pipefail
          STATUS="OK"
          [[ "${CODE:-200}" != "200" ]] && STATUS="WARN (${CODE:-?})"

          cat > slack-temp.json <<JSON
          {
            "text": "*SEO Checks (Ahrefs v3)* â€” ${STATUS}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*SEO Checks (Ahrefs v3)* â€” *${STATUS}*\\nâ€¢ *Target:* ${TARGET}\\nâ€¢ *DR:* ${DR}  â€¢ *Backlinks:* ${BL}  â€¢ *Ref domains:* ${RD}\\n<${URL_RUN}|Voir le run & tÃ©lÃ©charger lâ€™artefact>"
                }
              }
            ]
          }
          JSON

          curl -s -X POST -H 'Content-type: application/json' \
            --data @slack-temp.json "$SLACK_WEBHOOK_URL" >/dev/null || true

name: ğŸ§¾ Daily Workflows Audit Report

on:
  schedule:
    - cron: "0 9 * * *"   # Tous les jours Ã  9h UTC (10h Paris)
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”§ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup GitHub CLI + jq
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq gh

      - name: ğŸ§  Run TPS Batch Workflow Audit
        run: |
          chmod +x ./audit-workflows.sh
          ./audit-workflows.sh

      - name: ğŸ—‚ï¸ Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: TPS-Workflows-Audit
          path: rapports/Workflows/

      - name: âœ‰ï¸ Send report via Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ğŸ§¾ TPS-STAR â€” Daily Workflows Audit Report"
          to: hello@thepetsociety.paris
          from: "TPS Automation <no-reply@thepetsociety.paris>"
          body: |
            Hi Alex ğŸ‘‹

            Here is your automated daily report of all TPS GitHub workflows.
            The attached CSV lists which jobs succeeded, failed, or were skipped.

            ğŸ•’ Generated automatically at ${{ github.run_started_at }}

            â€” TPS Automation
          attachments: |
            rapports/Workflows/*.csv

      - name: ï¿½ï¿½ Notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          LATEST=$(ls -1 rapports/Workflows/audit-workflows-*.csv | tail -n1)
          SUMMARY=$(awk -F',' 'NR>1 {c[$3]++} END{printf "âœ… %d  âŒ %d  âšª %d  âš™ï¸ %d", c["success"]+0, c["failure"]+0, c["neutral"]+0, c[""]+0}' "$LATEST")
          TEXT="*TPS-STAR â€” Daily Workflows Audit*\n$SUMMARY\nâ€¢ CSV attachÃ© en *artifact*\nâ€¢ DÃ©tails du run : $RUN_URL"
          curl -X POST -H 'Content-type: application/json' \
            --data "$(jq -Rn --arg t "$TEXT" '{text:$t}')" \
            "$SLACK_WEBHOOK_URL" || true

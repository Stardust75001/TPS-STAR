on:
  workflow_dispatch:
permissions:
  contents: read
  actions: write
  workflows: write

permissions:
  contents: read
  actions: write
  workflows: write

---
name: ğŸ§© Full Metrics Chain (Verify â†’ Resume â†’ PDF)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1" # chaque lundi Ã  08:00 UTC

jobs:
  run-verify:
    name: ğŸ” Verify Metrics Connections
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§© Trigger Metrics Verification
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "ğŸ“Š Verify All Metrics Integrations"
          ref: DEV

  run-resume:
    name: ğŸ§¾ Resume Metrics Summary
    needs: run-verify
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§  Trigger Resume Workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "ğŸ§¾ Resume Metrics + Trigger PDF Build"
          ref: DEV

  run-pdf:
    name: ğŸ§¾ Generate Metrics PDF Report
    needs: run-resume
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¤ Trigger PDF Generation
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "ğŸ§¾ Metrics PDF Report"
          ref: DEV

  notify-slack:
    name: ğŸ’¬ Notify Slack (Summary)
    needs: run-pdf
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ’¬ Send final Slack summary
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          echo "ğŸ“¡ Sending summary to Slack..."
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\":white_check_mark: *Weekly metrics chain complete!*\nğŸ“ [Run details]($RUN_URL)\"}" \
            "$SLACK_WEBHOOK_URL" || true

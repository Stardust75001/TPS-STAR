name: ğŸ§© Full Metrics Chain (Verify â†’ Resume â†’ PDF)

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  workflows: write

jobs:
  verify:
    name: ğŸ” Verify Metrics Connections
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Trigger Metrics Verification
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "metrics.yml"  # correspond exactement au nom du fichier cible
          ref: DEV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  resume:
    name: ğŸ§¾ Resume Metrics Summary
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Trigger Resume Metrics Workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "resume-metrics.yml"
          ref: DEV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  pdf:
    name: ğŸ“Š Generate Metrics PDF Report
    needs: resume
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Trigger PDF Workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "metrics-pdf.yml"
          ref: DEV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  slack:
    name: ğŸ’¬ Notify Slack Summary
    needs: pdf
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“¢ Send Slack Notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          STATUS=":white_check_mark: *Metrics chain completed successfully!*"
          if [ "${{ needs.verify.result }}" = "failure" ] || \
             [ "${{ needs.resume.result }}" = "failure" ] || \
             [ "${{ needs.pdf.result }}" = "failure" ]; then
             STATUS=":x: *Some steps failed in the metrics chain!*"
          fi
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$STATUS\nğŸ“ [View details]($RUN_URL)\"}" \
            "$SLACK_WEBHOOK_URL"

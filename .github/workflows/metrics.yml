# ============================================================
# üìä THE PET SOCIETY ‚Äî Verify All Metrics Integrations (Full)
# V√©rifie la validit√© de toutes les API cl√©s (Sentry, GA4, CF, etc.)
# et g√©n√®re un rapport Slack + CSV local
# ============================================================

name: üìä Verify All Metrics Integrations

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # Chaque jour √† 03:00 UTC

permissions:
  contents: read
  actions: write

jobs:
  metrics:
    name: üîß Check All Metrics Integrations
    runs-on: ubuntu-latest

    env:
      SENTRY_DSN:           ${{ secrets.SENTRY_DSN }}
      CLOUDFLARE_TOKEN:     ${{ secrets.CLOUDFLARE_TOKEN }}
      META_TOKEN:           ${{ secrets.META_TOKEN }}
      GA4_TOKEN:            ${{ secrets.GA4_TOKEN }}
      AHREFS_API_KEY:       ${{ secrets.AHREFS_API_KEY }}
      GTM_ID:               ${{ secrets.GTM_ID }}
      ZIK_TOKEN:            ${{ secrets.ZIK_TOKEN }}
      GSC_CREDENTIALS_JSON: ${{ secrets.GSC_CREDENTIALS_JSON }}
      GSC_PROPERTY_URL:     ${{ secrets.GSC_PROPERTY_URL }}
      SLACK_WEBHOOK_URL:    ${{ secrets.SLACK_WEBHOOK_URL }}

    outputs:
      summary: ${{ steps.summary.outputs.text }}

    steps:
      - uses: actions/checkout@v4

      - name: üïí Set run start time
        id: start
        run: echo "RUN_STARTED_AT=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV

      # ---------- Google Search Console ----------
      - name: üß† Google Search Console
        id: gsc
        continue-on-error: true
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run GSC Verification
        id: gsc_run
        continue-on-error: true
        run: |
          pip install --quiet google-api-python-client google-auth
          python - <<'PY'
          import os, json, sys
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          try:
              creds = json.loads(os.environ["GSC_CREDENTIALS_JSON"])
              scopes = ["https://www.googleapis.com/auth/webmasters.readonly"]
              creds = service_account.Credentials.from_service_account_info(creds, scopes=scopes)
              svc = build("webmasters","v3",credentials=creds,cache_discovery=False)
              site = os.environ["GSC_PROPERTY_URL"]
              sites = svc.sites().list().execute().get("siteEntry", [])
              if not any(s.get("siteUrl")==site for s in sites):
                  print("‚ùå GSC: acc√®s refus√© √†", site); sys.exit(67)
              svc.sitemaps().list(siteUrl=site).execute()
              print("‚úÖ GSC: OK")
          except Exception as e:
              print("‚ùå GSC:", e); sys.exit(67)
          PY

      # ---------- Basic secret checks ----------
      - name: Basic secret checks
        id: secrets
        continue-on-error: true
        run: |
          check_secret() {
            local name="$1" value="$2"
            if [ -n "$value" ]; then
              echo "‚úÖ $name pr√©sent"
            else
              echo "‚ùå $name manquant"
              echo "$name,MISSING" >> metrics_report.csv
            fi
          }

          echo "Service,Status" > metrics_report.csv
          check_secret "SENTRY_DSN" "$SENTRY_DSN"
          check_secret "CLOUDFLARE_TOKEN" "$CLOUDFLARE_TOKEN"
          check_secret "META_TOKEN" "$META_TOKEN"
          check_secret "GA4_TOKEN" "$GA4_TOKEN"
          check_secret "AHREFS_API_KEY" "$AHREFS_API_KEY"
          check_secret "GTM_ID" "$GTM_ID"
          check_secret "ZIK_TOKEN" "$ZIK_TOKEN"

      # ---------- Cloudflare Token Verification ----------
      - name: ‚òÅÔ∏è Cloudflare Token Verification
        continue-on-error: true
        run: |
          echo "üß™ V√©rification du token Cloudflare..."
          curl -s "https://api.cloudflare.com/client/v4/user/tokens/verify" \
            -H "Authorization: Bearer $CLOUDFLARE_TOKEN" | jq -r '.result.status // "‚ö†Ô∏è √âchec"' || true

      # ---------- R√©sum√© ----------
      - name: üîç R√©sum√© METRICS
        id: summary
        run: |
          echo "üìä METRICS SUMMARY"
          html="<table border='1' cellspacing='0' cellpadding='6' style='border-collapse:collapse;font-family:Arial,sans-serif;min-width:420px'>
          <tr style='background:#f2f2f2'><th>Service</th><th>Statut</th></tr>"
          while IFS=, read -r service status; do
            [ "$service" = "Service" ] && continue
            html="$html<tr><td>$service</td><td style='text-align:center;'>$status</td></tr>"
          done < metrics_report.csv
          html="$html</table>"

          echo "text<<EOF" >> $GITHUB_OUTPUT
          echo "$html"    >> $GITHUB_OUTPUT
          echo "EOF"      >> $GITHUB_OUTPUT

      - name: üìÇ Upload CSV report
        uses: actions/upload-artifact@v4
        with:
          name: metrics_report
          path: metrics_report.csv

  notify:
    needs: metrics
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: üí¨ Slack Notification
        run: |
          STATUS="${{ needs.metrics.result }}"
          COLOR=$([ "$STATUS" = "success" ] && echo "#2eb886" || echo "#ff0000")
          TEXT="üìä *TPS Metrics Chain:* $STATUS\nDate: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          curl -X POST -H "Content-Type: application/json" \
            --data "{\"attachments\":[{\"color\":\"$COLOR\",\"blocks\":[{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"$TEXT\"}}]}]}" \
            "${{ secrets.SLACK_WEBHOOK_URL }}" || echo "‚ö†Ô∏è Slack notification skipped"

name: "ðŸ“Š Weekly Business Report â€” THE PET SOCIETY"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"

permissions:
  contents: write
  actions: write

jobs:
  weekly_report:
    name: "ðŸš€ TPS Weekly Business Intelligence"
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "ðŸ“¦ Install Python dependencies"
        run: |
          pip install reportlab matplotlib pandas requests

      - name: "ðŸ“ Init report_data directory"
        run: mkdir -p report_data

      - name: "ðŸ› Export Shopify KPIs"
        env:
          SHOPIFY_STORE_DOMAIN: ${{ secrets.SHOPIFY_STORE_DOMAIN }}
          SHOPIFY_ADMIN_API_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ADMIN_API_ACCESS_TOKEN }}
        run: |
          python3 scripts/export_shopify_metrics.py

      - name: "ðŸ“ˆ Export GA4 KPIs"
        env:
          GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}
          GA4_TOKEN: ${{ secrets.GA4_TOKEN }}
        run: |
          python3 scripts/export_ga4_metrics.py

      - name: "ðŸ§© Merge all metrics into metrics_full_report.csv"
        run: |
          {
            echo "source,metric,value";
            csv_files=$(ls report_data/*metrics.csv);
            for file in $csv_files; do
              prefix=$(basename "$file" | sed 's/_metrics.csv//');
              tail -n +2 "$file" | while IFS= read -r line; do
                echo "$prefix,$line";
              done
            done
          } > report_data/metrics_full_report.csv

      - name: "ðŸ“„ Generate Full Business Report PDF"
        run: |
          python3 scripts/generate_tps_business_report.py \
            report_data/metrics_full_report.csv \
            TPS-Executive-Business-Report.pdf

      - name: "ðŸ§  Generate 1-page Executive Summary"
        run: |
          python3 scripts/generate_tps_exec_summary.py \
            report_data/metrics_full_report.csv \
            TPS-Executive-Summary-1page.pdf

      - name: "ðŸ“¤ Upload reports as GitHub artifact"
        uses: actions/upload-artifact@v4
        with:
          name: "TPS-Business-Reports"
          path: |
            TPS-Executive-Business-Report.pdf
            TPS-Executive-Summary-1page.pdf
          retention-days: 30

      - name: "ðŸ’¬ Push report info to Slack (#reports)"
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TEXT="*ðŸ“Š Weekly Business Report â€” THE PET SOCIETY*\n\n"
          TEXT+="â€¢ Full report: TPS-Executive-Business-Report.pdf\n"
          TEXT+="â€¢ Executive 1-page: TPS-Executive-Summary-1page.pdf\n\n"
          TEXT+="ðŸ”— <${RUN_URL}|Voir les artifacts dans GitHub Actions>\n"

          PAYLOAD=$(jq -n --arg text "$TEXT" '{text: $text}')

          curl -X POST -H "Content-type: application/json" \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL" || true

      - name: "ðŸ“§ Email fallback if Slack fails"
        if: failure()
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          {
            echo "Subject: TPS Business Report â€” Slack Failure";
            echo "From: ${SMTP_USER}";
            echo "To: ${EMAIL_RECIPIENT}";
            echo "";
            echo "Slack notification failed.";
            echo "Reports available here:";
            echo "${RUN_URL}";
          } | sendmail -t

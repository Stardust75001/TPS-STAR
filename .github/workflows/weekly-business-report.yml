name: "ðŸ“Š Weekly Business Report â€” THE PET SOCIETY"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"   # Lundi 08:00 UTC

permissions:
  contents: write
  actions: write

jobs:
  weekly_report:
    name: "ðŸš€ TPS Weekly Business Intelligence"
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------
      # CHECKOUT
      # ----------------------------------------------------------
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # PYTHON ENV
      # ----------------------------------------------------------
      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "ðŸ“¦ Install Python dependencies"
        run: |
          pip install reportlab matplotlib pandas requests

      # ----------------------------------------------------------
      # CREATE REPORT_DATA
      # ----------------------------------------------------------
      - name: "ðŸ“ Init report_data directory"
        run: mkdir -p report_data

      # ----------------------------------------------------------
      # SHOPIFY EXPORT
      # ----------------------------------------------------------
      - name: "ðŸ› Export Shopify KPIs"
        env:
          SHOPIFY_STORE_DOMAIN: ${{ secrets.SHOPIFY_STORE_DOMAIN }}
          SHOPIFY_ADMIN_API_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ADMIN_API_ACCESS_TOKEN }}
        run: |
          python3 scripts/export_shopify_metrics.py

      # ----------------------------------------------------------
      # GA4 EXPORT
      # ----------------------------------------------------------
      - name: "ðŸ“ˆ Export GA4 KPIs"
        env:
          GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}
          GA4_TOKEN: ${{ secrets.GA4_TOKEN }}
        run: |
          python3 scripts/export_ga4_metrics.py

      # ----------------------------------------------------------
      # MERGE CSV
      # ----------------------------------------------------------
      - name: "ðŸ§© Merge all metrics into metrics_full_report.csv"
        run: |
          {
            echo "source,metric,value";
            csv_files=$(ls report_data/*metrics.csv);
            for file in $csv_files; do
              prefix=$(basename "$file" | sed 's/_metrics.csv//');
              tail -n +2 "$file" | while IFS= read -r line; do
                echo "$prefix,$line";
              done
            done
          } > report_data/metrics_full_report.csv

      # ----------------------------------------------------------
      # PDF GENERATION
      # ----------------------------------------------------------
      - name: "ðŸ“„ Generate Executive PDF Business Report"
        run: |
          python3 scripts/generate_tps_business_report.py \
            report_data/metrics_full_report.csv \
            TPS-Executive-Business-Report.pdf

      # ----------------------------------------------------------
      # UPLOAD ARTIFACT
      # ----------------------------------------------------------
      - name: "ðŸ“¤ Upload report as GitHub artifact"
        uses: actions/upload-artifact@v4
        with:
          name: "TPS-Business-Report"
          path: TPS-Executive-Business-Report.pdf
          retention-days: 30

      # ----------------------------------------------------------
      # SLACK NOTIFICATION
      # ----------------------------------------------------------
      - name: "ðŸ’¬ Push report to Slack (#reports)"
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          STATUS="Report generated âœ“"
          TEXT="*ðŸ“Š Weekly Business Report â€” THE PET SOCIETY*\n\n"
          TEXT+="â€¢ Shopify KPIs âœ“\n"
          TEXT+="â€¢ GA4 KPIs âœ“\n"
          TEXT+="â€¢ Executive PDF âœ“\n\n"
          TEXT+="ðŸ”— <${RUN_URL}|Voir le workflow>\n"

          PAYLOAD=$(jq -n \
            --arg text "$TEXT" \
            '{text: $text}')

          curl -X POST -H "Content-type: application/json" \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL" \
            || true

      # ----------------------------------------------------------
      # EMAIL FALLBACK
      # ----------------------------------------------------------
      - name: "ðŸ“§ Email fallback if Slack fails"
        if: failure()
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          {
            echo "Subject: TPS Business Report â€” Slack Failure";
            echo "From: ${SMTP_USER}";
            echo "To: ${EMAIL_RECIPIENT}";
            echo "";
            echo "Slack notification failed.";
            echo "Report available here:";
            echo "${RUN_URL}";
          } | sendmail -t

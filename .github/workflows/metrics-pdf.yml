# ============================================================
# üßæ THE PET SOCIETY ‚Äî Weekly Metrics PDF Generator
# Full workflow: build ‚Üí PDF ‚Üí Slack ‚Üí Email
# ============================================================

name: üßæ Metrics PDF Report

on:
  workflow_dispatch:
  schedule:
    - cron: "10 8 * * 1" # Chaque lundi √† 08:10 UTC

jobs:
  metrics-pdf:
    name: üìä Generate Weekly Metrics PDF
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # 1Ô∏è‚É£ Checkout repo
      # --------------------------------------------------------
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # 2Ô∏è‚É£ Build HTML summary
      # --------------------------------------------------------
      - name: üß† Build HTML summary
        run: |
          set -e
          mkdir -p reports
          echo "<h2>THE PET SOCIETY ‚Äî Weekly Metrics Summary</h2>" > reports/summary.html
          echo "<p>Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>" >> reports/summary.html
          echo "<ul>" >> reports/summary.html

          if [ -n "${{ secrets.SENTRY_DSN }}" ]; then
            echo "<li>‚úÖ Sentry DSN ‚Äî Present</li>" >> reports/summary.html
          else
            echo "<li>‚ùå Sentry DSN ‚Äî Missing</li>" >> reports/summary.html
          fi

          CF_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.cloudflare.com/client/v4/user/tokens/verify" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_TOKEN }}")
          if [ "$CF_CODE" = "200" ]; then
            echo "<li>‚úÖ Cloudflare Token ‚Äî Valid</li>" >> reports/summary.html
          else
            echo "<li>‚ùå Cloudflare Token ‚Äî Invalid ($CF_CODE)</li>" >> reports/summary.html
          fi

          AH_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.ahrefs.com/v3/site-explorer/domain-rating?target=thepetsociety.paris&mode=domain" \
            -H "Authorization: Bearer ${{ secrets.AHREFS_API_KEY }}")
          if [ "$AH_CODE" = "200" ]; then
            echo "<li>‚úÖ Ahrefs API ‚Äî Connected</li>" >> reports/summary.html
          else
            echo "<li>‚ùå Ahrefs API ‚Äî Failed ($AH_CODE)</li>" >> reports/summary.html
          fi

          if [ -n "${{ secrets.GA4_REFRESH_TOKEN }}" ]; then
            echo "<li>‚úÖ GA4 Refresh Token ‚Äî Present</li>" >> reports/summary.html
          else
            echo "<li>‚ùå GA4 Refresh Token ‚Äî Missing</li>" >> reports/summary.html
          fi

          echo "</ul>" >> reports/summary.html
          echo "<p style='font-style:italic'>End of report ‚Äî $(date)</p>" >> reports/summary.html

      # --------------------------------------------------------
      # 3Ô∏è‚É£ Install wkhtmltopdf
      # --------------------------------------------------------
      - name: üß± Install wkhtmltopdf
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wkhtmltopdf

      # --------------------------------------------------------
      # 4Ô∏è‚É£ Generate PDF
      # --------------------------------------------------------
      - name: üßæ Generate PDF report
        run: |
          wkhtmltopdf reports/summary.html reports/metrics-report.pdf
          ls -lh reports/metrics-report.pdf
          echo "‚úÖ PDF generated successfully"

      # --------------------------------------------------------
      # 5Ô∏è‚É£ Upload artifact
      # --------------------------------------------------------
      - name: üíæ Upload artifact (PDF)
        uses: actions/upload-artifact@v4
        with:
          name: metrics-weekly-report
          path: reports/metrics-report.pdf
          if-no-files-found: error
          retention-days: 14

      # --------------------------------------------------------
      # 6Ô∏è‚É£ Slack upload (bot)
      # --------------------------------------------------------
      - name: üí¨ Upload PDF to Slack (bot upload)
        run: |
          if [ -n "${{ secrets.SLACK_BOT_TOKEN }}" ] && [ -n "${{ secrets.SLACK_CHANNEL_ID }}" ]; then
            echo "üì§ Uploading metrics PDF to Slack..."
            curl -f -s -S -X POST \
              -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
              -F "channels=${{ secrets.SLACK_CHANNEL_ID }}" \
              -F "initial_comment=üßæ *THE PET SOCIETY ‚Äî Weekly Metrics PDF*\n‚úÖ PDF uploaded successfully." \
              -F "file=@reports/metrics-report.pdf" \
              https://slack.com/api/files.upload \
              && echo "‚úÖ PDF uploaded to Slack" \
              || echo "‚ö†Ô∏è Slack upload failed"
          else
            echo "‚ÑπÔ∏è Slack bot credentials not configured, skipping upload."
          fi

      # --------------------------------------------------------
      # 7Ô∏è‚É£ Slack fallback (webhook)
      # --------------------------------------------------------
      - name: üí¨ Slack Fallback via Webhook
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ] && \
             { [ -z "${{ secrets.SLACK_BOT_TOKEN }}" ] || [ -z "${{ secrets.SLACK_CHANNEL_ID }}" ]; }; then
            echo "ü™Ñ Sending fallback Slack message..."
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\":page_facing_up: Weekly Metrics PDF generated ‚Äî <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Download here>\"}" \
              "${{ secrets.SLACK_WEBHOOK_URL }}"
          else
            echo "‚ÑπÔ∏è Webhook fallback not applicable."
          fi

      # --------------------------------------------------------
      # 8Ô∏è‚É£ Email report (optional)
      # --------------------------------------------------------
      - name: üìß Email PDF (optional via sendmail)
        run: |
          if [ -n "${{ secrets.SMTP_USER }}" ] && [ -n "${{ secrets.EMAIL_RECIPIENT }}" ]; then
            if ! command -v sendmail >/dev/null 2>&1; then
              echo "‚ö†Ô∏è sendmail not available, skipping email."
              exit 0
            fi

            latest_file="reports/metrics-report.pdf"
            BOUNDARY="MIMEBOUNDARY-$(date +%s)"

            {
              echo "Subject: THE PET SOCIETY ‚Äî Weekly Metrics PDF"
              echo "From: ${{ secrets.SMTP_USER }}"
              echo "To: ${{ secrets.EMAIL_RECIPIENT }}"
              echo "MIME-Version: 1.0"
              echo "Content-Type: multipart/mixed; boundary=\"$BOUNDARY\""
              echo
              echo "--$BOUNDARY"
              echo "Content-Type: text/plain; charset=UTF-8"
              echo
              echo "Bonjour,"
              echo
              echo "Veuillez trouver ci-joint le rapport hebdomadaire THE PET SOCIETY."
              echo
              echo "--$BOUNDARY"
              echo "Content-Type: application/pdf; name=\"metrics-report.pdf\""
              echo "Content-Transfer-Encoding: base64"
              echo "Content-Disposition: attachment; filename=\"metrics-report.pdf\""
              echo
              base64 -w 0 "$latest_file"
              echo
              echo "--$BOUNDARY--"
            } | sendmail -t

            echo "‚úÖ Email sent to ${{ secrets.EMAIL_RECIPIENT }}"
          else
            echo "‚ÑπÔ∏è Email configuration missing, skipping send."
          fi

      # --------------------------------------------------------
      # 9Ô∏è‚É£ Slack summary confirmation
      # --------------------------------------------------------
      - name: ‚úÖ Slack Summary Message
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "üß© Sending summary to Slack..."
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\":white_check_mark: *Metrics PDF completed successfully!*\nüìé <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Run details>\"}" \
              "${{ secrets.SLACK_WEBHOOK_URL }}" || true
          else
            echo "‚ÑπÔ∏è No Slack webhook configured, summary skipped."
          fi

on:
  workflow_dispatch:
permissions:
  contents: read
  actions: write
  workflows: write

on:
  workflow_dispatch:
permissions:
  contents: read
  actions: write
  workflows: write

permissions:
  contents: read
  actions: write
  workflows: write

# --- üßæ Metrics PDF Report ---
name: üßæ Metrics PDF Report

on:
  workflow_dispatch:
  schedule:
    - cron: "10 8 * * 1" # chaque lundi √† 08:10 UTC

jobs:
  metrics-pdf:
    name: üìä Generate Weekly Metrics PDF
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: üß† Build HTML summary
        run: |
          set -e
          mkdir -p reports
          echo "<h2>THE PET SOCIETY ‚Äî Weekly Metrics Summary</h2>" > reports/summary.html
          echo "<p>Generated: \$(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>" >> reports/summary.html
          echo "<ul>" >> reports/summary.html

          if [ -n "\${{ secrets.SENTRY_DSN }}" ]; then
            echo "<li>‚úÖ Sentry DSN ‚Äî Present</li>" >> reports/summary.html
          else
            echo "<li>‚ùå Sentry DSN ‚Äî Missing</li>" >> reports/summary.html
          fi

          CF_CODE=\$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.cloudflare.com/client/v4/user/tokens/verify" \
            -H "Authorization: Bearer \${{ secrets.CLOUDFLARE_TOKEN }}")
          if [ "\$CF_CODE" = "200" ]; then
            echo "<li>‚úÖ Cloudflare Token ‚Äî Valid</li>" >> reports/summary.html
          else
            echo "<li>‚ùå Cloudflare Token ‚Äî Invalid (\$CF_CODE)</li>" >> reports/summary.html
          fi

          AH_CODE=\$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.ahrefs.com/v3/site-explorer/domain-rating?target=thepetsociety.paris&mode=domain" \
            -H "Authorization: Bearer \${{ secrets.AHREFS_API_KEY }}")
          if [ "\$AH_CODE" = "200" ]; then
            echo "<li>‚úÖ Ahrefs API ‚Äî Connected</li>" >> reports/summary.html
          else
            echo "<li>‚ùå Ahrefs API ‚Äî Failed (\$AH_CODE)</li>" >> reports/summary.html
          fi

          if [ -n "\${{ secrets.GA4_REFRESH_TOKEN }}" ]; then
            echo "<li>‚úÖ GA4 Refresh Token ‚Äî Present</li>" >> reports/summary.html
          else
            echo "<li>‚ùå GA4 Refresh Token ‚Äî Missing</li>" >> reports/summary.html
          fi

          echo "</ul>" >> reports/summary.html
          echo "<p style='font-style:italic'>End of report ‚Äî \$(date)</p>" >> reports/summary.html

      - name: üß± Install wkhtmltopdf
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wkhtmltopdf

      - name: üßæ Generate PDF report
        run: |
          wkhtmltopdf reports/summary.html reports/metrics-report.pdf
          ls -lh reports/metrics-report.pdf
          echo "‚úÖ PDF generated successfully"

      - name: üíæ Upload artifact (PDF)
        uses: actions/upload-artifact@v4
        with:
          name: metrics-weekly-report
          path: reports/metrics-report.pdf
          if-no-files-found: error
          retention-days: 14


jobs:
  slack:
    name: üí¨ Notify Slack Summary
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: üì¢ Send Slack Notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          STATUS=":white_check_mark: *Metrics chain completed successfully!*"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS=":x: *Metrics chain encountered errors!*"
          fi
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$STATUS\nüìé [View details]($RUN_URL)\"}" \
            "$SLACK_WEBHOOK_URL"


jobs:
  slack:
    name: üí¨ Notify Slack Summary
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: üì¢ Send Slack Notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          STATUS=":white_check_mark: *Metrics chain completed successfully!*"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS=":x: *Metrics chain encountered errors!*"
          fi
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$STATUS\nüìé [View details]($RUN_URL)\"}" \
            "$SLACK_WEBHOOK_URL"

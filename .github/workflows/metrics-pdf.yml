permissions:
  contents: read
  actions: write
  workflows: write

# --- ğŸ§¾ Metrics PDF Report ---
name: ğŸ§¾ Metrics PDF Report

on:
  workflow_dispatch:
  schedule:
    - cron: "10 8 * * 1" # chaque lundi Ã  08:10 UTC

jobs:
  metrics-pdf:
    name: ğŸ“Š Generate Weekly Metrics PDF
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§  Build HTML summary
        run: |
          set -e
          mkdir -p reports
          echo "<h2>THE PET SOCIETY â€” Weekly Metrics Summary</h2>" > reports/summary.html
          echo "<p>Generated: \$(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>" >> reports/summary.html
          echo "<ul>" >> reports/summary.html

          if [ -n "\${{ secrets.SENTRY_DSN }}" ]; then
            echo "<li>âœ… Sentry DSN â€” Present</li>" >> reports/summary.html
          else
            echo "<li>âŒ Sentry DSN â€” Missing</li>" >> reports/summary.html
          fi

          CF_CODE=\$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.cloudflare.com/client/v4/user/tokens/verify" \
            -H "Authorization: Bearer \${{ secrets.CLOUDFLARE_TOKEN }}")
          if [ "\$CF_CODE" = "200" ]; then
            echo "<li>âœ… Cloudflare Token â€” Valid</li>" >> reports/summary.html
          else
            echo "<li>âŒ Cloudflare Token â€” Invalid (\$CF_CODE)</li>" >> reports/summary.html
          fi

          AH_CODE=\$(curl -s -o /dev/null -w "%{http_code}" \
            "https://api.ahrefs.com/v3/site-explorer/domain-rating?target=thepetsociety.paris&mode=domain" \
            -H "Authorization: Bearer \${{ secrets.AHREFS_API_KEY }}")
          if [ "\$AH_CODE" = "200" ]; then
            echo "<li>âœ… Ahrefs API â€” Connected</li>" >> reports/summary.html
          else
            echo "<li>âŒ Ahrefs API â€” Failed (\$AH_CODE)</li>" >> reports/summary.html
          fi

          if [ -n "\${{ secrets.GA4_REFRESH_TOKEN }}" ]; then
            echo "<li>âœ… GA4 Refresh Token â€” Present</li>" >> reports/summary.html
          else
            echo "<li>âŒ GA4 Refresh Token â€” Missing</li>" >> reports/summary.html
          fi

          echo "</ul>" >> reports/summary.html
          echo "<p style='font-style:italic'>End of report â€” \$(date)</p>" >> reports/summary.html

      - name: ğŸ§± Install wkhtmltopdf
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wkhtmltopdf

      - name: ğŸ§¾ Generate PDF report
        run: |
          wkhtmltopdf reports/summary.html reports/metrics-report.pdf
          ls -lh reports/metrics-report.pdf
          echo "âœ… PDF generated successfully"

      - name: ğŸ’¾ Upload artifact (PDF)
        uses: actions/upload-artifact@v4
        with:
          name: metrics-weekly-report
          path: reports/metrics-report.pdf
          if-no-files-found: error
          retention-days: 14

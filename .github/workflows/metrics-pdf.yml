name: "ðŸ“Š TPS Business PDF + Slack"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"  # Chaque lundi 8h UTC

permissions:
  contents: write

jobs:
  build-report:
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v4

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "Install deps"
        run: |
          python -m pip install --upgrade pip
          pip install matplotlib pandas reportlab

      - name: "Ensure report_data directory"
        run: mkdir -p report_data

      # ICI tu peux insÃ©rer plus tard des steps pour :
      # - exporter shopify_metrics.csv
      # - exporter ga4_metrics.csv
      # - exporter meta_metrics.csv
      # - etc.

      - name: "Generate FULL Business Report"
        run: |
          python scripts/generate_tps_business_report.py \
            report_data/metrics_report.csv \
            reports/TPS-Executive-Business-Report-$(date -u +%Y%m%d).pdf \
            full

      - name: "Generate Executive OnePager"
        run: |
          python scripts/generate_tps_business_report.py \
            report_data/metrics_report.csv \
            reports/TPS-Executive-OnePager-$(date -u +%Y%m%d).pdf \
            executive

      - name: "Commit & push reports"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "tps-bot"
          git config user.email "bot@thepetsociety.paris"
          git add reports/*.pdf || true
          if git diff --cached --quiet; then
            echo "No new reports to commit."
            exit 0
          fi
          git commit -m "chore: add weekly TPS business reports"
          git push origin DEV

      - name: "Notify Slack #reports"
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
        run: |
          REPORT_DATE=$(date -u +%Y-%m-%d)
          TEXT="*TPS Weekly Business Reports â€” ${REPORT_DATE}*\n\
          - Full report: \`reports/TPS-Executive-Business-Report-${REPORT_DATE//-/}.pdf\`\n\
          - Executive one-pager: \`reports/TPS-Executive-OnePager-${REPORT_DATE//-/}.pdf\`"

          payload=$(jq -n --arg text "$TEXT" '{text:$text}')
          curl -s -X POST -H "Content-type: application/json" \
            --data "$payload" "$SLACK_WEBHOOK_URL" || echo "Slack webhook failed"

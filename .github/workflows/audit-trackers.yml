name: "üîé Audit Trackers (GA4 / Meta / Ahrefs / Cloudflare / Sentry)"

on:
  workflow_dispatch:
    inputs:
      path:
        description: "Chemin √† tester (ex: /, /collections/all, /products/foo)"
        default: "/"
        required: true
  schedule:
    - cron: "15 3 * * *" # 03:15 UTC quotidien

env:
  DOMAIN: ${{ secrets.TPS_DOMAIN }}
  EXPECT_GA4_ID: ${{ secrets.EXPECT_GA4_ID }}
  EXPECT_META_PIXEL_ID: ${{ secrets.EXPECT_META_PIXEL_ID }}
  EXPECT_AHREFS_VERIF: ${{ secrets.EXPECT_AHREFS_VERIF }}
  EXPECT_CF_TOKEN: ${{ secrets.EXPECT_CF_TOKEN }}
  EXPECT_SENTRY_DSN: ${{ secrets.EXPECT_SENTRY_DSN }}
  AHREFS_API_KEY: ${{ secrets.AHREFS_API_KEY }} # facultatif

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: ‚úÖ Sanity check des variables
        run: |
          test -n "${DOMAIN}" || { echo "‚ùå secrets.TPS_DOMAIN manquant"; exit 1; }
          echo "üîó Domaine: ${DOMAIN}"

      - name: üîç T√©l√©charge la page cible
        id: fetch
        env:
          PATH_TO_TEST: ${{ github.event.inputs.path || '/' }}
        run: |
          URL="${DOMAIN%/}${PATH_TO_TEST}"
          echo "URL: $URL"
          code=$(curl -sIL -o /dev/null -w '%{http_code}' "$URL")
          echo "HTTP: $code"
          [ "$code" -ge 200 ] && [ "$code" -lt 400 ] || { echo "‚ùå Page non accessible ($code)"; exit 1; }
          curl -sL -A "TPS-Bot/1.0 (+audit-trackers)" "$URL" > page.html
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: üß™ V√©rifie les trackers
        id: check
        run: |
          fail=0
          show(){ printf "%s\n" "$*"; }

          # GA4
          if [ -n "${EXPECT_GA4_ID}" ]; then
            grep -q "${EXPECT_GA4_ID}" page.html && show "‚úÖ GA4 (${EXPECT_GA4_ID})" || { show "‚ùå GA4 attendu non trouv√© (${EXPECT_GA4_ID})"; fail=1; }
          else
            grep -Eq 'gtag/js\?id=G-|G-[A-Z0-9]+' page.html && show "‚úÖ GA4 (pattern)" || show "‚ö†Ô∏è GA4 non d√©tect√© (pattern)"
          fi

          # Meta Pixel
          if [ -n "${EXPECT_META_PIXEL_ID}" ]; then
            grep -q "${EXPECT_META_PIXEL_ID}" page.html && show "‚úÖ Meta Pixel (${EXPECT_META_PIXEL_ID})" || { show "‚ùå Meta Pixel attendu non trouv√© (${EXPECT_META_PIXEL_ID})"; fail=1; }
          else
            grep -q "fbq(" page.html && show "‚úÖ Meta Pixel (pattern)" || show "‚ö†Ô∏è Meta Pixel non d√©tect√© (pattern)"
          fi

          # Ahrefs verification (balise meta)
          if [ -n "${EXPECT_AHREFS_VERIF}" ]; then
            grep -qi "<meta[^>]*name=['\"]ahrefs-site-verification['\"][^>]*content=['\"]${EXPECT_AHREFS_VERIF}['\"]" page.html \
              && show "‚úÖ Ahrefs verification" || { show "‚ùå Ahrefs verification manquante ou incorrecte"; fail=1; }
          else
            grep -qi "ahrefs-site-verification" page.html && show "‚úÖ Ahrefs verification (pattern)" || show "‚ö†Ô∏è Ahrefs verification non d√©tect√©e"
          fi

          # Cloudflare Beacon
          if [ -n "${EXPECT_CF_TOKEN}" ]; then
            grep -q "cloudflareinsights.com/beacon.min.js" page.html && grep -q "${EXPECT_CF_TOKEN}" page.html \
              && show "‚úÖ Cloudflare Beacon (token ok)" || { show "‚ùå Cloudflare Beacon manquant ou token diff√©rent"; fail=1; }
          else
            grep -q "cloudflareinsights.com/beacon.min.js" page.html && show "‚úÖ Cloudflare Beacon (pattern)" || show "‚ö†Ô∏è Cloudflare Beacon non d√©tect√©"
          fi

          # Sentry
          if [ -n "${EXPECT_SENTRY_DSN}" ]; then
            grep -q "${EXPECT_SENTRY_DSN}" page.html && show "‚úÖ Sentry (DSN trouv√©)" || { show "‚ùå Sentry DSN non trouv√©"; fail=1; }
          else
            grep -q "browser.sentry-cdn.com" page.html && show "‚úÖ Sentry (pattern)" || show "‚ö†Ô∏è Sentry non d√©tect√©"
          fi

          if [ $fail -eq 0 ]; then status="SUCCESS ‚úÖ"; else status="FAILED ‚ùå"; fi
          echo "status=$status" >> "$GITHUB_OUTPUT"
          echo "$fail" > fail.flag
          exit $fail || true

      - name: üìà Ahrefs v3 (facultatif)
        if: always()
        id: ahrefs
        run: |
          host="$(echo "${DOMAIN}" | sed 's#https\?://##; s#/$##')"
          if [ -n "${AHREFS_API_KEY}" ]; then
            echo "‚Üí Test Ahrefs v3 metrics pour ${host}‚Ä¶"
            res="$(curl -s -H "Authorization: Bearer ${AHREFS_API_KEY}" \
              "https://api.ahrefs.com/v3/site-explorer/metrics?target=${host}&mode=domain")"
            echo "$res" > ahrefs.json
            if echo "$res" | grep -q '"Error"'; then
              echo "‚ö†Ô∏è Ahrefs: plan sans acc√®s API ou cl√© invalide (OK si non Enterprise)."
            fi
          else
            echo '{"info":"AHREFS_API_KEY absent"}' > ahrefs.json
            echo "‚ÑπÔ∏è AHREFS_API_KEY non d√©fini ‚Äî on saute l‚Äôappel API."
          fi

      - name: üì¶ Archive (page + logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-trackers-artifacts
          path: |
            page.html
            fail.flag
            ahrefs.json

      - name: ‚úâÔ∏è Pr√©pare le payload Slack
        if: always()
        run: |
          URL="${{ steps.fetch.outputs.url }}"
          STATUS="${{ steps.check.outputs.status }}"
          {
            echo '{'
            echo '  "text": "*TPS-STAR ‚Äî Audit Trackers*",'
            echo '  "blocks": ['
            echo '    {"type":"section","text":{"type":"mrkdwn","text":"*'"$STATUS"'* ‚Äî <'"$URL"'|'"$URL"'>"}},'
            echo '    {"type":"context","elements":[{"type":"mrkdwn","text":"Run: <https://github.com/'"${{ github.repository }}"'/actions/runs/'"${{ github.run_id }}"'|#'"${{ github.run_number }}"'>"}]}'
            echo '  ]'
            echo '}'
          } > slack-temp.json

      - name: üí¨ Notification Slack
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload-file-path: slack-temp.json
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEB

      - name: üî¥ √âchec si erreurs critiques
        if: always()
        run: |
          [ -f fail.flag ] && [ "$(cat fail.flag)" != "0" ] && { echo "‚ùå √âchecs d√©tect√©s"; exit 1; } || echo "‚úÖ OK"

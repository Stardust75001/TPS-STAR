---
name: "ğŸ§  Verify + Resume + PDF + Slack (Dual Mode)"

on:
  workflow_dispatch:
  push:
    branches: ["DEV"]
  schedule:
    - cron: "0 8 * * 1" # Chaque lundi Ã  8h UTC

permissions:
  contents: read
  actions: write

defaults:
  run:
    working-directory: ${{ github.workspace }}

jobs:
  chain:
    name: "âš™ï¸ TPS Metrics Chain"
    runs-on: ubuntu-latest
    outputs:
      verify_result: ${{ steps.verify_step.outcome }}
      resume_result: ${{ steps.resume_step.outcome }}
      pdf_result: ${{ steps.pdf_step.outcome }}

    steps:
      # -------------------------------
      # ğŸš€ Trigger des 3 workflows
      # -------------------------------
      - name: "ğŸš€ Trigger metrics.yml"
        id: verify_step
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "metrics.yml"
          ref: DEV
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ§¾ Trigger resume-metrics.yml"
        id: resume_step
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "resume-metrics.yml"
          ref: DEV
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ“Š Trigger metrics-pdf.yml"
        id: pdf_step
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "metrics-pdf.yml"
          ref: DEV
          token: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------
      # ğŸ”° Init CSV agrÃ©gÃ© local
      # -------------------------------
      - name: "ğŸ—‚ï¸ Init metrics_report.csv"
        run: |
          echo "Service,Status" > metrics_report.csv

      # -------------------------------
      # â˜ï¸ Cloudflare Token Verification
      # -------------------------------
      - name: "â˜ï¸ Verify Cloudflare Token"
        run: |
          echo "ğŸ” Checking Cloudflare token validity..."
          if [ -z "${{ secrets.CLOUDFLARE_TOKEN }}" ]; then
            echo "CLOUDFLARE_TOKEN,MISSING" >> metrics_report.csv
            exit 0
          fi

          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_TOKEN }}" \
            https://api.cloudflare.com/client/v4/user/tokens/verify)
          VALID=$(echo "$RESPONSE" | jq -r '.success')

          if [ "$VALID" = "true" ]; then
            echo "CLOUDFLARE_TOKEN,OK" >> metrics_report.csv
            echo "âœ… Cloudflare token valid."
          else
            echo "CLOUDFLARE_TOKEN,INVALID" >> metrics_report.csv
            echo "âš ï¸ Cloudflare token invalid or expired."
          fi

      # -------------------------------
      # ğŸ”— Meta Token Verification
      # -------------------------------
      - name: "ğŸ”— Verify Meta Token"
        run: |
          echo "ğŸ” Checking Meta Token validity..."
          if [ -z "${{ secrets.META_TOKEN }}" ]; then
            echo "META_TOKEN,MISSING" >> metrics_report.csv
            exit 0
          fi

          RESPONSE=$(curl -s -X GET \
            "https://graph.facebook.com/debug_token?input_token=${{ secrets.META_TOKEN }}&access_token=${{ secrets.META_TOKEN }}")
          VALID=$(echo "$RESPONSE" | jq -r '.data.is_valid')

          if [ "$VALID" = "true" ]; then
            echo "META_TOKEN,OK" >> metrics_report.csv
            echo "âœ… Meta Token is valid."
          else
            echo "META_TOKEN,INVALID" >> metrics_report.csv
            echo "âš ï¸ Meta Token invalid or expired."
          fi

      # -------------------------------
      # ğŸŸ  Sentry DSN Verification
      # -------------------------------
      - name: "ğŸŸ  Verify Sentry DSN"
        run: |
          echo "ğŸ” Checking Sentry DSN..."
          if [ -z "${{ secrets.SENTRY_DSN }}" ]; then
            echo "SENTRY_DSN,MISSING" >> metrics_report.csv
            exit 0
          fi

          if [[ "${{ secrets.SENTRY_DSN }}" =~ ^https:\/\/[0-9a-f]+@[a-zA-Z0-9.-]+\/[0-9]+$ ]]; then
            echo "SENTRY_DSN,OK" >> metrics_report.csv
            echo "âœ… Sentry DSN format valid."
          else
            echo "SENTRY_DSN,INVALID" >> metrics_report.csv
            echo "âš ï¸ Sentry DSN format invalid."
          fi

      # -------------------------------
      # ğŸŸ  Google Analytics (GA4 Token)
      # -------------------------------
      - name: "ğŸŸ  Verify Google Analytics (GA4 Token)"
        run: |
          echo "ğŸ” Checking Google Analytics GA4 Token..."
          if [ -z "${{ secrets.GA4_TOKEN }}" ]; then
            echo "GA4_TOKEN,MISSING" >> metrics_report.csv
            exit 0
          fi

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            "https://www.google-analytics.com/mp/collect?measurement_id=G-XXXXXXX&api_secret=${{ secrets.GA4_TOKEN }}" \
            -d '{}')

          if [ "$RESPONSE" = "400" ] || [ "$RESPONSE" = "200" ]; then
            echo "GA4_TOKEN,OK" >> metrics_report.csv
            echo "âœ… GA4 Token present (HTTP $RESPONSE)."
          else
            echo "GA4_TOKEN,INVALID" >> metrics_report.csv
            echo "âš ï¸ GA4 Token invalid or not accepted (HTTP $RESPONSE)."
          fi

      # -------------------------------
      # ğŸŸ  Ahrefs API Verification
      # -------------------------------
      - name: "ğŸŸ  Verify Ahrefs API"
        run: |
          echo "ğŸ” Checking Ahrefs API key..."
          if [ -z "${{ secrets.AHREFS_API_KEY }}" ]; then
            echo "AHREFS_API_KEY,MISSING" >> metrics_report.csv
            exit 0
          fi

          RESPONSE=$(curl -s \
            "https://apiv2.ahrefs.com?token=${{ secrets.AHREFS_API_KEY }}&from=subscription&mode=domain")
          STATUS=$(echo "$RESPONSE" | jq -r '.subscription_id // empty')

          if [ -n "$STATUS" ]; then
            echo "AHREFS_API_KEY,OK" >> metrics_report.csv
            echo "âœ… Ahrefs API key valid."
          else
            echo "AHREFS_API_KEY,INVALID" >> metrics_report.csv
            echo "âš ï¸ Ahrefs API key invalid or request failed."
          fi

      # -------------------------------
      # ğŸŸ  Google Tag Manager Verification
      # -------------------------------
      - name: "ğŸŸ  Verify Google Tag Manager ID"
        run: |
          echo "ğŸ” Checking Google Tag Manager ID..."
          if [ -z "${{ secrets.GTM_ID }}" ]; then
            echo "GTM_ID,MISSING" >> metrics_report.csv
            exit 0
          fi

          if [[ "${{ secrets.GTM_ID }}" =~ ^GTM-[A-Z0-9]+$ ]]; then
            echo "GTM_ID,OK" >> metrics_report.csv
            echo "âœ… GTM ID format valid."
          else
            echo "GTM_ID,INVALID" >> metrics_report.csv
            echo "âš ï¸ GTM ID format invalid."
          fi

      # -------------------------------
      # ğŸŸ  Zik Analytics Verification
      # -------------------------------
      - name: "ğŸŸ  Verify Zik Analytics API Key"
        run: |
          echo "ğŸ” Checking Zik Analytics API Key..."
          if [ -z "${{ secrets.ZIK_API_KEY }}" ]; then
            echo "ZIK_API_KEY,MISSING" >> metrics_report.csv
            exit 0
          fi

          if [[ "${{ secrets.ZIK_API_KEY }}" =~ ^[a-zA-Z0-9]{32,}$ ]]; then
            echo "ZIK_API_KEY,OK" >> metrics_report.csv
            echo "âœ… Zik API Key format valid."
          else
            echo "ZIK_API_KEY,INVALID" >> metrics_report.csv
            echo "âš ï¸ Zik API Key format invalid."
          fi

      # -------------------------------
      # ğŸŸ  Google Search Console Verification
      # -------------------------------
      - name: "ğŸŸ  Verify Google Search Console (credentials + property)"
        run: |
          echo "ğŸ” Checking Google Search Console credentials and property..."
          if [ -z "${{ secrets.GSC_CREDENTIALS }}" ]; then
            echo "GSC_CREDENTIALS,MISSING" >> metrics_report.csv
            exit 0
          fi
          if [ -z "${{ secrets.GSC_PROPERTY }}" ]; then
            echo "GSC_PROPERTY,MISSING" >> metrics_report.csv
            exit 0
          fi

          echo "${{ secrets.GSC_CREDENTIALS }}" > gsc_creds.json
          ACCESS_TOKEN=$(curl -s -X POST -H "Content-Type: application/json" \
            -d @gsc_creds.json \
            "https://oauth2.googleapis.com/token" | jq -r '.access_token // empty')

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "GSC_CREDENTIALS,INVALID" >> metrics_report.csv
            echo "âš ï¸ GSC credentials invalid."
            exit 0
          fi

          RESPONSE=$(curl -s -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://searchconsole.googleapis.com/webmasters/v3/sites/${{ secrets.GSC_PROPERTY }}")
          SITE_URL=$(echo "$RESPONSE" | jq -r '.siteUrl // empty')

          if [ -n "$SITE_URL" ]; then
            echo "GSC_CREDENTIALS,OK" >> metrics_report.csv
            echo "GSC_PROPERTY,OK" >> metrics_report.csv
            echo "âœ… GSC credentials and property valid."
          else
            echo "GSC_PROPERTY,INVALID" >> metrics_report.csv
            echo "âš ï¸ GSC property not found or invalid."
          fi

      # -------------------------------
      # ğŸŸ  Slack Webhook + Bot Token + Channel
      # -------------------------------
      - name: "ğŸŸ  Verify Slack Webhook + Bot Token + Channel"
        run: |
          echo "ğŸ” Checking Slack Webhook, Bot Token and Channel..."

          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "SLACK_WEBHOOK_URL,MISSING" >> metrics_report.csv
          else
            RESP=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "Content-Type: application/json" \
              --data '{"text":"Test from GitHub Actions"}' "${{ secrets.SLACK_WEBHOOK_URL }}")
            if [ "$RESP" = "200" ]; then
              echo "SLACK_WEBHOOK_URL,OK" >> metrics_report.csv
              echo "âœ… Slack webhook works."
            else
              echo "SLACK_WEBHOOK_URL,INVALID" >> metrics_report.csv
              echo "âš ï¸ Slack webhook failed (HTTP $RESP)."
            fi
          fi

          if [ -z "${{ secrets.SLACK_BOT_TOKEN }}" ]; then
            echo "SLACK_BOT_TOKEN,MISSING" >> metrics_report.csv
          else
            USER=$(curl -s -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
              https://slack.com/api/auth.test | jq -r '.user_id // empty')
            if [ -n "$USER" ]; then
              echo "SLACK_BOT_TOKEN,OK" >> metrics_report.csv
              echo "âœ… Slack bot token valid."
            else
              echo "SLACK_BOT_TOKEN,INVALID" >> metrics_report.csv
              echo "âš ï¸ Slack bot token invalid."
            fi
          fi

          if [ -z "${{ secrets.SLACK_CHANNEL }}" ]; then
            echo "SLACK_CHANNEL,MISSING" >> metrics_report.csv
          else
            echo "SLACK_CHANNEL,OK" >> metrics_report.csv
            echo "âœ… Slack channel set."
          fi

      # -------------------------------
      # ğŸŸ  SMTP Verification (host, port, user, pass, to)
      # -------------------------------
      - name: "ğŸŸ  Verify SMTP (host, port, user, pass, to)"
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_TO:   ${{ secrets.SMTP_TO }}
        run: |
          echo "ğŸ” Checking SMTP configuration..."
          STATUS=0
          for VAR in SMTP_HOST SMTP_PORT SMTP_USER SMTP_PASS SMTP_TO; do
            if [ -z "${!VAR}" ]; then
              echo "$VAR,MISSING" >> metrics_report.csv
              echo "âŒ $VAR missing in GitHub secrets/env"
              STATUS=1
            else
              echo "$VAR,OK" >> metrics_report.csv
            fi
          done

          if [ $STATUS -eq 0 ]; then
            if timeout 5 bash -c "</dev/tcp/${SMTP_HOST}/${SMTP_PORT}" 2>/dev/null; then
              echo "SMTP_CONNECT,OK" >> metrics_report.csv
              echo "âœ… SMTP host/port reachable."
            else
              echo "SMTP_CONNECT,ERROR" >> metrics_report.csv
              echo "âš ï¸ SMTP host/port not reachable."
            fi
          fi

      # -------------------------------
      # ğŸŸ  Shopify API Key Verification
      # -------------------------------
      - name: "ğŸŸ  Verify Shopify API Key"
        run: |
          echo "ğŸ” Checking Shopify API Key..."
          if [ -z "${{ secrets.SHOPIFY_API_KEY }}" ]; then
            echo "SHOPIFY_API_KEY,MISSING" >> metrics_report.csv
            exit 0
          fi

          if [[ "${{ secrets.SHOPIFY_API_KEY }}" =~ ^[a-zA-Z0-9]{32}$ ]]; then
            echo "SHOPIFY_API_KEY,OK" >> metrics_report.csv
            echo "âœ… Shopify API Key format valid."
          else
            echo "SHOPIFY_API_KEY,INVALID" >> metrics_report.csv
            echo "âš ï¸ Shopify API Key format invalid."
          fi

      # -------------------------------
      # ğŸŸ  Amplitude API Key Verification
      # -------------------------------
      - name: "ğŸŸ  Verify Amplitude API Key"
        run: |
          echo "ğŸ” Checking Amplitude API Key..."
          if [ -z "${{ secrets.AMPLITUDE_API_KEY }}" ]; then
            echo "AMPLITUDE_API_KEY,MISSING" >> metrics_report.csv
            exit 0
          fi

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://api2.amplitude.com/identify" \
            -H "Content-Type: application/json" \
            -d "{\"api_key\":\"${{ secrets.AMPLITUDE_API_KEY }}\",\"identification\":[{\"user_id\":\"test\"}]}")

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "400" ]; then
            echo "AMPLITUDE_API_KEY,OK" >> metrics_report.csv
            echo "âœ… Amplitude API Key present (HTTP $RESPONSE)."
          else
            echo "AMPLITUDE_API_KEY,INVALID" >> metrics_report.csv
            echo "âš ï¸ Amplitude API Key invalid or not accepted (HTTP $RESPONSE)."
          fi

      # -------------------------------
      # ğŸŸ  Email Recipient Verification
      # -------------------------------
      - name: "ğŸŸ  Verify Email Recipient"
        run: |
          echo "ğŸ” Checking Email Recipient..."
          if [ -z "${{ secrets.EMAIL_RECIPIENT }}" ]; then
            echo "EMAIL_RECIPIENT,MISSING" >> metrics_report.csv
            exit 0
          fi

          if [[ "${{ secrets.EMAIL_RECIPIENT }}" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
            echo "EMAIL_RECIPIENT,OK" >> metrics_report.csv
            echo "âœ… Email recipient format valid."
          else
            echo "EMAIL_RECIPIENT,INVALID" >> metrics_report.csv
            echo "âš ï¸ Email recipient format invalid."
          fi

      # -------------------------------
      # ğŸ“Š GÃ©nÃ©ration HTML + upload artifacts
      # -------------------------------
      - name: "ğŸ“Š Generate HTML summary for dashboard"
        run: |
          echo '<table><tr><th>Service</th><th>Status</th></tr>' > metrics_report.html
          tail -n +2 metrics_report.csv | while IFS=, read service status; do
            color="red"
            [ "$status" = "OK" ] && color="green"
            printf '<tr><td>%s</td><td style="color:%s;">%s</td></tr>\n' "$service" "$color" "$status" >> metrics_report.html
          done
          echo '</table>' >> metrics_report.html

      - name: "ğŸ“¦ Upload metrics report artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: "metrics-report"
          path: |
            metrics_report.csv
            metrics_report.html

  notify:
    name: "ğŸ’¬ TPS Slack Summary (Dark or Light)"
    needs: chain
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ¾ Send Slack summary (dual mode)"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SLACK_MODE: ${{ vars.SLACK_MODE || 'dark' }}
        run: |
          echo "ğŸ“¡ Sending Slack summary in mode: $SLACK_MODE"

          emoji() {
            case "$1" in
              success) echo "ğŸŸ¢" ;;
              failure) echo "ğŸ”´" ;;
              cancelled) echo "âšª" ;;
              *) echo "âš™ï¸" ;;
            esac
          }

          V=$(emoji "${{ needs.chain.outputs.verify_result }}")
          R=$(emoji "${{ needs.chain.outputs.resume_result }}")
          P=$(emoji "${{ needs.chain.outputs.pdf_result }}")

          if [ "$SLACK_MODE" = "light" ]; then
            COLOR="#EAF2FB"
            TITLE="ğŸª¶ *TPS-STAR â€” Light Mode Metrics Summary*"
            TEXT="*TPS-STAR â€” Workflow Chain Summary (Light)*\n"
          else
            COLOR="#1E1E1E"
            TITLE="ğŸ¾ *THE PET SOCIETY â€” Dark Metrics Summary*"
            TEXT="*THE PET SOCIETY â€” Workflow Chain Summary (Dark)*\n"
          fi

          TEXT+="\`\`\`\n"
          TEXT+="ğŸ§  metrics.yml ............. ${V}  ${{ needs.chain.outputs.verify_result }}\n"
          TEXT+="ğŸ“œ resume-metrics.yml ..... ${R}  ${{ needs.chain.outputs.resume_result }}\n"
          TEXT+="ğŸ“Š metrics-pdf.yml ........ ${P}  ${{ needs.chain.outputs.pdf_result }}\n"
          TEXT+="ğŸ•’ $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n"
          TEXT+="ğŸ”— ${RUN_URL}\n"
          TEXT+="\`\`\`\n"

          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --arg title "$TITLE" \
            --arg text "$TEXT" \
            '{attachments:[{color:$color,blocks:[
              {type:"header",text:{type:"plain_text",text:$title,emoji:true}},
              {type:"section",text:{type:"mrkdwn",text:$text}}
            ]}]}')

          curl -s -X POST -H "Content-Type: application/json" \
            --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" \
            && echo "âœ… Slack summary sent" \
            || echo "âš ï¸ Slack webhook failed."

      - name: "ğŸ“§ Email fallback (if Slack fails)"
        if: failure()
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          echo "ğŸ“¨ Sending fallback email..."
          {
            echo "Subject: [TPS] Metrics Chain Summary â€” Failure"
            echo "From: ${SMTP_USER}"
            echo "To: ${EMAIL_RECIPIENT}"
            echo "MIME-Version: 1.0"
            echo "Content-Type: text/plain; charset=UTF-8"
            echo
            echo "TPS-STAR Workflow Report (Fallback)"
            echo
            echo "metrics.yml ............. ${{ needs.chain.outputs.verify_result }}"
            echo "resume-metrics.yml ...... ${{ needs.chain.outputs.resume_result }}"
            echo "metrics-pdf.yml ......... ${{ needs.chain.outputs.pdf_result }}"
            echo
            echo "Details: ${RUN_URL}"
            echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          } | sendmail -t

          echo "âœ… Email fallback executed"

---
name: "üß† Verify + Resume + PDF + Slack (Dual Mode)"

on:
  workflow_dispatch:
  push:
    branches: ["DEV"]
  schedule:
    - cron: "0 8 * * 1" # Chaque lundi √† 8h UTC

permissions:
  contents: read
  actions: write

defaults:
  run:
    working-directory: ${{ github.workspace }}

jobs:
  chain:
    name: "‚öôÔ∏è TPS Metrics Chain"
    runs-on: ubuntu-latest
    outputs:
      verify_result: ${{ steps.verify_step.outcome }}
      resume_result: ${{ steps.resume_step.outcome }}
      pdf_result: ${{ steps.pdf_step.outcome }}

    steps:
      - name: "üöÄ Trigger metrics.yml"
        id: verify_step
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "metrics.yml"
          ref: DEV
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "üßæ Trigger resume-metrics.yml"
        id: resume_step
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "resume-metrics.yml"
          ref: DEV
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "üìä Trigger metrics-pdf.yml"
        id: pdf_step
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "metrics-pdf.yml"
          ref: DEV
          token: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------
      # üî∞ Init CSV agr√©g√© local
      # -------------------------------
      - name: "üóÇÔ∏è Init metrics_report.csv"
        run: |
          echo "Service,Status" > metrics_report.csv

      # -------------------------------
      # ‚òÅÔ∏è Cloudflare Token Verification
      # -------------------------------
      - name: "‚òÅÔ∏è Verify Cloudflare Token"
        id: cf_check
        run: |
          echo "üîç Checking Cloudflare token validity..."
          if [ -z "${{ secrets.CLOUDFLARE_TOKEN }}" ]; then
            echo "‚ùå CLOUDFLARE_TOKEN missing in GitHub secrets"
            echo "Service,Status" > cloudflare_report.csv
            echo "CLOUDFLARE_TOKEN,MISSING" >> cloudflare_report.csv
            cat cloudflare_report.csv >> metrics_report.csv
            exit 0
          fi

          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_TOKEN }}" \
            https://api.cloudflare.com/client/v4/user/tokens/verify)
          VALID=$(echo "$RESPONSE" | jq -r '.success')

          echo "Service,Status" > cloudflare_report.csv
          if [ "$VALID" = "true" ]; then
            echo "CLOUDFLARE_TOKEN,OK" >> cloudflare_report.csv
            echo "‚úÖ Cloudflare token valid."
          else
            echo "CLOUDFLARE_TOKEN,INVALID" >> cloudflare_report.csv
            echo "‚ö†Ô∏è Cloudflare token invalid or expired."
          fi

          cat cloudflare_report.csv >> metrics_report.csv

      # -------------------------------
      # üîó Meta Token Verification
      # -------------------------------
      - name: "üîó Verify Meta Token"
        id: meta_check
        run: |
          echo "üîç Checking Meta Token validity..."
          if [ -z "${{ secrets.META_TOKEN }}" ]; then
            echo "‚ùå META_TOKEN missing in GitHub secrets"
            echo "Service,Status" > meta_report.csv
            echo "META_TOKEN,MISSING" >> meta_report.csv
            cat meta_report.csv >> metrics_report.csv
            exit 0
          fi

          RESPONSE=$(curl -s -X GET \
            "https://graph.facebook.com/debug_token?input_token=${{ secrets.META_TOKEN }}&access_token=${{ secrets.META_TOKEN }}")
          VALID=$(echo "$RESPONSE" | jq -r '.data.is_valid')

          echo "Service,Status" > meta_report.csv
          if [ "$VALID" = "true" ]; then
            echo "META_TOKEN,OK" >> meta_report.csv
            echo "‚úÖ Meta Token is valid."
          else
            echo "META_TOKEN,INVALID" >> meta_report.csv
            echo "‚ö†Ô∏è Meta Token invalid or expired."
          fi

          cat meta_report.csv >> metrics_report.csv

  notify:
    name: "üí¨ TPS Slack Summary (Dark or Light)"
    needs: chain
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: "üêæ Send Slack summary (dual mode)"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SLACK_MODE: ${{ vars.SLACK_MODE || 'dark' }}
        run: |
          echo "üì° Sending Slack summary in mode: $SLACK_MODE"

          emoji() {
            case "$1" in
              success) echo "üü¢" ;;
              failure) echo "üî¥" ;;
              cancelled) echo "‚ö™" ;;
              *) echo "‚öôÔ∏è" ;;
            esac
          }

          V=$(emoji "${{ needs.chain.outputs.verify_result }}")
          R=$(emoji "${{ needs.chain.outputs.resume_result }}")
          P=$(emoji "${{ needs.chain.outputs.pdf_result }}")

          if [ "$SLACK_MODE" = "light" ]; then
            COLOR="#EAF2FB"
            TITLE="ü™∂ *TPS-STAR ‚Äî Light Mode Metrics Summary*"
            TEXT="*TPS-STAR ‚Äî Workflow Chain Summary (Light)*\n"
          else
            COLOR="#1E1E1E"
            TITLE="üêæ *THE PET SOCIETY ‚Äî Dark Metrics Chain Summary*"
            TEXT="*THE PET SOCIETY ‚Äî Workflow Chain Summary (Dark)*\n"
          fi

          TEXT+="\`\`\`\n"
          TEXT+="üß† metrics.yml ............. ${V}  ${{ needs.chain.outputs.verify_result }}\n"
          TEXT+="üìú resume-metrics.yml ..... ${R}  ${{ needs.chain.outputs.resume_result }}\n"
          TEXT+="üìä metrics-pdf.yml ........ ${P}  ${{ needs.chain.outputs.pdf_result }}\n"
          TEXT+="üïí $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n"
          TEXT+="üîó ${RUN_URL}\n"
          TEXT+="\`\`\`\n"

          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --arg title "$TITLE" \
            --arg text "$TEXT" \
            '{attachments:[{color:$color,blocks:[
              {type:"header",text:{type:"plain_text",text:$title,emoji:true}},
              {type:"section",text:{type:"mrkdwn",text:$text}}
            ]}]}')

          curl -s -X POST -H "Content-Type: application/json" \
            --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" \
            && echo "‚úÖ Slack summary sent" \
            || echo "‚ö†Ô∏è Slack webhook failed."

      - name: "üìß Email fallback (if Slack fails)"
        if: failure()
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          echo "üì® Sending fallback email..."
          {
            echo "Subject: [TPS] Metrics Chain Summary ‚Äî Failure"
            echo "From: ${SMTP_USER}"
            echo "To: ${EMAIL_RECIPIENT}"
            echo "MIME-Version: 1.0"
            echo "Content-Type: text/plain; charset=UTF-8"
            echo
            echo "TPS-STAR Workflow Report (Fallback)"
            echo
            echo "metrics.yml ............. ${{ needs.chain.outputs.verify_result }}"
            echo "resume-metrics.yml ...... ${{ needs.chain.outputs.resume_result }}"
            echo "metrics-pdf.yml ......... ${{ needs.chain.outputs.pdf_result }}"
            echo
            echo "Details: ${RUN_URL}"
            echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          } | sendmail -t

          echo "‚úÖ Email fallback executed"

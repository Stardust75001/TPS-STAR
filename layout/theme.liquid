{% comment %}
  Auto-generated by Shogun. Optimized by ChatGPT for Lighthouse and Theme Check.
{% endcomment %}

{% render 'shogun-content-handler' %}
<!doctype html>
<html
  lang="{{ request.locale.iso_code }}"
  dir="ltr"
  class="{% if settings.animations_on_scroll %}scroll-on-animations{% endif %}"
  {% if settings.browser_tab_enable %}
    data-inactive-tab-text="{{ settings.browser_tab_text }}"
  {% endif %}
>
  <head>
    {% comment %}
    SENTRY - Tracking global des erreurs front
    {% endcomment %}
    <script
      src="https://js-de.sentry-cdn.com/72a646f950001f6ec2292d3064978d94.min.js"
      crossorigin="anonymous"
    ></script>
    <script>
      Sentry.onLoad(function() {
        Sentry.init({
          dsn: "https://72a646f950001f6ec2292d3064978d94@o4509330673303552.ingest.de.sentry.io/4510291474972752",
          integrations: [new Sentry.BrowserTracing()],
          tracesSampleRate: 1.0,
          replaysSessionSampleRate: 0.1,
          replaysOnErrorSampleRate: 1.0,
        });
      });
    </script>

    {% comment %} Google Analytics 4 {% endcomment %}
    {% if settings.google_analytics_4_measurement_id != blank %}
      <!-- Google tag (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id={{ settings.google_analytics_4_measurement_id }}"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{ settings.google_analytics_4_measurement_id }}');
      </script>
    {% endif %}

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="{{ settings.color_primary }}">
    <meta name="language" content="{{ request.locale.iso_code }}">
    {% if template.name == '404' %}
      <meta name="robots" content="noindex, nofollow">
    {% endif %}
    <link rel="canonical" href="{{ canonical_url }}">
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    <link
      rel="preload"
      as="image"
      href="{{ 'TB_TOUCAN_VERDURE2_1200x800_DESKTOP_-_MODIFIED_30887a17-85b3-4aad-8599-f5b54c0a3583.png' | asset_url }}"
    >

    <link rel="alternate" hreflang="fr" href="{{ canonical_url | replace: '/de', '/fr' }}">
    <link rel="alternate" hreflang="de" href="{{ canonical_url | replace: '/fr', '/de' }}">
    <link
      rel="alternate"
      hreflang="x-default"
      href="{{ canonical_url | replace: '/fr', '' | replace: '/de', '' }}"
    >

    {% unless settings.favicon == blank %}
      <link
        rel="icon"
        type="image/png"
        sizes="16x16"
        href="{{ settings.favicon | image_url: width: 16, height: 16, crop: 'center' }}"
      >
      <link
        rel="icon"
        type="image/png"
        sizes="32x32"
        href="{{ settings.favicon | image_url: width: 32, height: 32, crop: 'center' }}"
      >
      <link
        rel="apple-touch-icon"
        sizes="180x180"
        href="{{ settings.favicon | image_url: width: 180, height: 180, crop: 'center' }}"
      >
    {% endunless %}

    <title>
      {{ page_title }}
      {% if current_tags %} – tagged "{{ current_tags | join: ', ' }}"{% endif %}
      {% if current_page != 1 %} – Page {{ current_page }}{% endif %}
      {% unless page_title contains shop.name %} – {{ shop.name }}{% endunless %}
    </title>
    {% if page_description -%}
      <meta name="description" content="{{ page_description | escape }}">
    {%- endif %}

    {% render 'seo-meta-tags' %}
    {% render 'structured-data' %}
    {{ content_for_header }}
    {% style %}{{ settings.code_css }}{% endstyle %}

    <link href="{{ 'vendor-bootstrap.min.css' | asset_url }}" rel="stylesheet">
    <link href="{{ 'vendor-splide.min.css' | asset_url }}" rel="stylesheet">
    <link href="{{ 'vendor-animate.min.css' | asset_url }}" rel="stylesheet">
    <link href="{{ 'variables.css' | asset_url }}" rel="stylesheet">
    <link href="{{ 'base.css' | asset_url }}" rel="stylesheet">
    <link href="{{ 'general.css' | asset_url }}" rel="stylesheet">
    <link href="{{ 'sections.css' | asset_url }}" rel="stylesheet">
    <link href="{{ 'collection.css' | asset_url }}" rel="stylesheet">
    <link href="{{ 'product.css' | asset_url }}" rel="stylesheet">
    <link href="{{ 'cart.css' | asset_url }}" rel="stylesheet">
    <link href="{{ 'custom-style.css' | asset_url }}" rel="stylesheet">

    {% if request.page_type == 'collection' %}
      <link href="{{ 'vendor-nouislider.min.css' | asset_url }}" rel="stylesheet">
      <script src="{{ 'vendor-nouislider.min.js' | asset_url }}" defer></script>
    {% endif %}

    {% if request.page_type == 'product' %}
      <link href="{{ 'vendor-glightbox.min.css' | asset_url }}" rel="stylesheet">
      <script src="{{ 'vendor-glightbox.min.js' | asset_url }}" defer></script>
    {% endif %}

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('img:not([loading])').forEach(img => {
          img.setAttribute('loading', 'lazy');
        });
      });
    </script>

    {% comment %} Sentry Monitoring {% endcomment %}
    <!-- Sentry Monitoring (local asset loader with CDN fallback) -->
    {% if settings.sentry_enabled and settings.sentry_dsn %}
      <script src="{{ 'sentry-init.js' | asset_url }}" defer></script>
    {% endif %}
    <!-- /Sentry Monitoring -->

    {{ settings.code_javascript }}
    {{ settings.code_head }}
    {% render 'shogun-head' %}
    ...
    <script
      src="https://analytics.ahrefs.com/analytics.js"
      data-key="7wUOKONM0Qb9EnacrK2nGg"
      async
    ></script>
    {%- render 'tracking-analytics' -%}

    {%- comment -%}
      THE PET SOCIETY — Integrations bootstrap
      Lit les métachamps Shopify:
        - custom_integrations.ga4_token                (ex: G-XXXXXXX)
        - custom_integrations.meta_pixel_id            (ex: 1973238620082976)
        - custom_integrations.sentry_dsn               (ex: https://<pubKey>@oXXXX.ingest.sentry.io/XXXX)
        - custom_integrations.cloudflare_beacon_token  (ex: 21fc2470e9e94a4b... )
    {%- endcomment -%}
    {%- liquid
      assign integ = shop.metafields.custom_integrations
      assign ga4_id     = integ.ga4_token            | default: '' | strip
      assign meta_id    = integ.meta_pixel_id        | default: '' | strip
      assign sentry_dsn = integ.sentry_dsn           | default: '' | strip
      assign cf_token   = integ.cloudflare_beacon_token | default: '' | strip
    -%}

    {%- comment -%} Expose aussi en JSON pur pour d'autres scripts {%- endcomment -%}
    <script id="tps-integrations" type="application/json">
      {
        "ga4": "{{ ga4_id | escape }}",
        "meta_pixel_id": "{{ meta_id | escape }}",
        "sentry_dsn": "{{ sentry_dsn | escape }}",
        "cloudflare_beacon_token": "{{ cf_token | escape }}"
      }
    </script>

    <script>
      (function () {
        // --- Parse JSON config once
        var cfgEl = document.getElementById('tps-integrations');
        var cfg = {};
        try { cfg = JSON.parse(cfgEl.textContent||'{}'); } catch(e){ cfg = {}; }

        // --- Expose sous un seul namespace global, évite les doublons
        window.TPS = window.TPS || {};
        window.TPS.integrations = Object.assign({}, window.TPS.integrations || {}, cfg);

        // --- Petit helper pour charger un script une seule fois
        function loadScript(src, id, attrs) {
          return new Promise(function(resolve, reject){
            if (id && document.getElementById(id)) return resolve();
            var s = document.createElement('script');
            s.src = src; s.async = true; if (id) s.id = id;
            if (attrs) Object.keys(attrs).forEach(k => s.setAttribute(k, attrs[k]));
            s.onload = resolve; s.onerror = reject;
            document.head.appendChild(s);
          });
        }

        // ============= SENTRY (si DSN présent) =============
        if (cfg.sentry_dsn) {
          // SDK navigateur + tracing
          loadScript('https://browser.sentry-cdn.com/7.120.1/bundle.tracing.replay.min.js', 'sentry-sdk')
          .then(function () {
            // eslint-disable-next-line no-undef
            Sentry.init({
              dsn: cfg.sentry_dsn,
              integrations: [
                // eslint-disable-next-line no-undef
                Sentry.browserTracingIntegration(),
                // eslint-disable-next-line no-undef
                Sentry.replayIntegration({ maskAllText: false, blockAllMedia: false })
              ],
              tracesSampleRate: 1.0,
              replaysSessionSampleRate: 0.1,
              replaysOnErrorSampleRate: 1.0,
              environment: "{{ request.locale.iso_code | upcase }}",
              release: "{{ shop.permanent_domain }}@{{ 'now' | date: '%Y-%m-%d' }}"
            });
          }).catch(function(){ console.warn('[TPS] Sentry SDK load failed'); });
        }

        // ============= GA4 (si ID présent) =============
        if (cfg.ga4) {
          loadScript('https://www.googletagmanager.com/gtag/js?id=' + encodeURIComponent(cfg.ga4), 'ga4')
          .then(function () {
            window.dataLayer = window.dataLayer || [];
            function gtag(){ dataLayer.push(arguments); }
            window.gtag = window.gtag || gtag;
            gtag('js', new Date());
            gtag('config', cfg.ga4, { 'anonymize_ip': true });
          }).catch(function(){ console.warn('[TPS] GA4 load failed'); });
        }

        // ============= META PIXEL (si ID présent) =============
        if (cfg.meta_pixel_id) {
          // fbq snippet officiel, protégé contre double init
          (function(f,b,e,v,n,t,s){
            if (f.fbq) return; n=f.fbq=function(){ n.callMethod ?
              n.callMethod.apply(n,arguments) : n.queue.push(arguments) };
            if (!f._fbq) f._fbq=n; n.push=n; n.loaded=!0; n.version='2.0';
            n.queue=[]; t=b.createElement(e); t.async=!0; t.src=v;
            s=b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t,s);
          })(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

          try {
            fbq('init', cfg.meta_pixel_id);
            fbq('track', 'PageView');
          } catch(e) { console.warn('[TPS] Meta Pixel init failed'); }
        }

        // ============= CLOUDFLARE BEACON (si token présent) =============
        if (cfg.cloudflare_beacon_token) {
          loadScript('https://static.cloudflareinsights.com/beacon.min.js', 'cf-beacon', {
            'defer': '',
            'data-cf-beacon': JSON.stringify({ token: cfg.cloudflare_beacon_token })
          }).catch(function(){ console.warn('[TPS] CF Beacon load failed'); });
        }
      })();
    </script>
    {% render 'integrations' %}
  </head>

  <body class="{{ request.page_type | prepend: 'page-type-' }}">
    <a class="visually-hidden-focusable" href="#main">
      {{- 'general.accessibility.skip_content' | t -}}
    </a>

    {% render 'right-clic' %}
    {% render 'scroll-top' %}
    {% render 'text-selection' %}
    {% render 'image-drag' %}
    {% render 'whatsapp-button' %}

    <div class="header-sticky-group">
      {% section 'announcement-bar' %}
      <div class="top-social-bar">
        <div class="social-icons-left">
          {% render 'social-icons-no-flags' %}
        </div>
        <div class="language-selector-right">
          <a href="/fr"><img src="{{ 'flag-fr.png' | asset_url }}" class="flag-icon" alt="FR"></a>
          <a href="/"><img src="{{ 'flag-en.png' | asset_url }}" class="flag-icon" alt="EN"></a>
          <a href="/de"><img src="{{ 'flag-de.png' | asset_url }}" class="flag-icon" alt="DE"></a>
        </div>
      </div>
      {% section 'discount-bar' %}
      <div class="announcement-text shipping-notice">
        {% assign lang = request.locale.iso_code %}
        <a href="{% if lang == 'fr' %}/fr/pages/eee{% elsif lang == 'de' %}/de/pages/eee{% else %}/pages/eee{% endif %}">
          {{- 'announcement.shipping_notice' | t -}}
        </a>
      </div>
      {% section 'navbar' %}
      {% section 'stories-bar-sticky-dynamic' %}
    </div>

    <main
      id="main"
      {% if template.name == 'index' %}
        class="homepage-main"
      {% endif %}
    >
      {{ content_for_layout }}
    </main>

    {% sections 'footer-group' %}
    {% render 'offcanvas-cart' %}
    {% render 'offcanvas-search' %}
    {% render 'offcanvas-wishlist' %}
    {% render 'back-to-top' %}

    <!-- Scripts déplacés ici pour améliorer le LCP -->
    <script src="{{ 'shopify_common.js' | shopify_asset_url }}" defer></script>
    <script src="{{ 'vendor-bootstrap.bundle.min.js' | asset_url }}" defer></script>
    <script src="{{ 'vendor-splide.min.js' | asset_url }}" defer></script>
    <script src="{{ 'base.js' | asset_url }}" defer></script>
    <script src="{{ 'general.js' | asset_url }}" defer></script>
    <script src="{{ 'search.js' | asset_url }}" async></script>
    <script src="{{ 'sections.js' | asset_url }}" async></script>
    <script src="{{ 'collection.js' | asset_url }}" async></script>
    <script src="{{ 'product.js' | asset_url }}" async></script>
    <script src="{{ 'cart.js' | asset_url }}" async></script>
    <script src="{{ 'custom.js' | asset_url }}" async></script>
    {% if settings.wishlist_enable %}
      <script src="{{ 'wishlist.js' | asset_url }}" async></script>
    {% endif %}
    <script src="{{ 'stories-tooltips.js' | asset_url }}" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPS Tracking - Test Local</title>
</head>
<body>
    <h1>üß™ TPS Tracking Test Suite</h1>

    <!-- Configuration simul√©e (comme dans Shopify) -->
    <script id="tps-integrations" type="application/json">
    {
        "ga4": "G-XXXXXXXXXX",
        "meta_pixel_id": "1973238620087976",
        "sentry_dsn": "",
        "cloudflare_beacon_token": ""
    }
    </script>

    <!-- SDK TPS -->
    <script>
        /*! THE PET SOCIETY ‚Äî Universal Tracking (GA4, Meta, Sentry, CF) v1.0 */
        (function () {
          "use strict";

          // ---------- Guard idempotence
          if (window.__TPS_TRACKING_LOADED__) return;
          window.__TPS_TRACKING_LOADED__ = true;

          // ---------- Tiny helpers
          const now = () => Date.now();
          const on = (el, ev, fn, opts) => el && el.addEventListener(ev, fn, opts || false);
          const $all = (sel, root = document) => Array.from(root.querySelectorAll(sel));
          const once = (fn) => {
            let done = false;
            return (...a) => { if (!done) { done = true; try { fn(...a); } catch(_) {} } };
          };
          const safe = (fn) => { try { return fn(); } catch (_) {} };

          // ---------- Read config injected in theme.liquid (see <script id="tps-integrations">)
          function readConfig() {
            const el = document.getElementById("tps-integrations");
            let cfg = {};
            if (el) {
              try { cfg = JSON.parse(el.textContent || "{}"); } catch (_) {}
            }
            return {
              ga4: cfg.ga4 || "",
              meta_pixel_id: cfg.meta_pixel_id || "",
              sentry_dsn: cfg.sentry_dsn || "",
              cloudflare_beacon_token: cfg.cloudflare_beacon_token || ""
            };
          }
          const CFG = readConfig();

          // ---------- Global namespace
          const TPS = (window.TPS = window.TPS || {});
          TPS.integrations = Object.assign({}, TPS.integrations || {}, CFG);

          // ---------- Queues (fire-and-forget even if libs late-load)
          const q = { gtag: [], fbq: [] };
          function flushQueues() {
            if (window.gtag && q.gtag.length) { q.gtag.splice(0).forEach(args => window.gtag(...args)); }
            if (window.fbq && q.fbq.length) { q.fbq.splice(0).forEach(args => window.fbq(...args)); }
          }
          const tryFlush = () => { flushQueues(); setTimeout(flushQueues, 1500); };

          // ---------- Core: trackEvent
          TPS.trackEvent = function (name, data) {
            if (!name) return;
            const payload = Object.assign({ event: name, ts: now() }, data || {});
            if (localStorage.getItem("TPS_DEBUG") === "1") {
              // eslint-disable-next-line no-console
              console.log("üß© TPS.trackEvent ‚Üí", JSON.parse(JSON.stringify(payload)));
            }

            // GA4
            if (CFG.ga4 && window.gtag) {
              window.gtag("event", name, payload);
            } else if (CFG.ga4) {
              q.gtag.push(["event", name, payload]);
            }

            // Meta Pixel
            if (CFG.meta_pixel_id && window.fbq) {
              window.fbq("trackCustom", name, payload);
            } else if (CFG.meta_pixel_id) {
              q.fbq.push(["trackCustom", name, payload]);
            }

            // Sentry breadcrumb (if Sentry present)
            safe(() => window.Sentry && window.Sentry.addBreadcrumb({
              category: "tps.event", level: "info", message: name, data: payload
            }));
          };

          // ---------- Debug helpers
          TPS.debug = {
            enable() { localStorage.setItem("TPS_DEBUG", "1"); location.reload(); },
            disable() { localStorage.removeItem("TPS_DEBUG"); location.reload(); },
            test(n = "Test Event", d = { foo: "bar" }) { TPS.trackEvent(n, d); }
          };

          // ---------- Auto hooks (lightweight)
          function autoHooks() {
            // 1) Newsletter forms: <form data-newsletter ...>
            $all("form[data-newsletter]").forEach(form => {
              on(form, "submit", () => {
                const email = safe(() => (new FormData(form)).get("email")) || "";
                TPS.trackEvent("Newsletter Signup", {
                  email: String(email || "").toLowerCase(),
                  location: form.getAttribute("data-location") || "unknown"
                });
              });
            });

            // 2) Product recommendations (data attributes on links)
            on(document, "click", (e) => {
              const a = e.target.closest("a[data-rec-product-id]");
              if (!a) return;
              TPS.trackEvent("Product Recommended Click", {
                product_id: a.getAttribute("data-rec-product-id"),
                position: Number(a.getAttribute("data-rec-position") || 0),
                source: a.getAttribute("data-rec-source") || "recommendations"
              });
            }, { capture: true });

            // 3) Generic Add to Cart buttons (opt-in with data-track-add)
            on(document, "click", (e) => {
              const btn = e.target.closest("[data-track-add]");
              if (!btn) return;
              TPS.trackEvent("Add to Cart", {
                product_id: btn.getAttribute("data-product-id") || "",
                product_name: btn.getAttribute("data-product-name") || "",
                price: Number(btn.getAttribute("data-price") || 0),
                source: btn.getAttribute("data-source") || "button"
              });
            }, { capture: true });

            // 4) Basic PageView (helps Meta/GA4 when SPA-ish themes)
            TPS.trackEvent("Page View", {
              path: location.pathname,
              title: document.title
            });
          }

          // ---------- Init once DOM is ready
          const init = once(function () {
            autoHooks();
            tryFlush();
          });

          if (document.readyState === "loading") {
            on(document, "DOMContentLoaded", init, { once: true });
          } else {
            init();
          }
        })();
    </script>

    <!-- Simuler GA4 pour test -->
    <script>
        window.gtag = function() {
            console.log('üìä [GA4 Mock]', ...arguments);
        };
    </script>

    <!-- Simuler Meta Pixel pour test -->
    <script>
        window.fbq = function() {
            console.log('üìò [Meta Mock]', ...arguments);
        };
    </script>

    <!-- Interface de test -->
    <div style="margin: 20px; font-family: Arial, sans-serif;">
        <h2>üéÆ Tests Interactifs</h2>

        <button onclick="testBasic()">üß™ Test Basic Event</button>
        <button onclick="testDebug()">üîç Enable Debug</button>
        <button onclick="checkStatus()">üìä Check Status</button>
        <br><br>

        <!-- Newsletter Test -->
        <form data-newsletter data-location="test-page" onsubmit="return false;">
            <input type="email" name="email" placeholder="test@example.com">
            <button type="submit">üìß Test Newsletter</button>
        </form>
        <br>

        <!-- Product Recommendation Test -->
        <a href="#" data-rec-product-id="123" data-rec-position="1" data-rec-source="test-page">
            üõçÔ∏è Test Product Recommendation Click
        </a>
        <br><br>

        <!-- Add to Cart Test -->
        <button data-track-add
                data-product-id="456"
                data-product-name="Test Product"
                data-price="29.99"
                data-source="test-button">
            üõí Test Add to Cart
        </button>

        <div id="results" style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
            <strong>R√©sultats des tests :</strong>
            <div id="log"></div>
        </div>
    </div>

    <script>
        // Override console.log pour afficher les r√©sultats
        const originalLog = console.log;
        const logDiv = document.getElementById('log');

        console.log = function(...args) {
            originalLog(...args);
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            logDiv.innerHTML += '<div style="margin: 5px 0; font-family: monospace; font-size: 12px;">' +
                                message + '</div>';
        };

        function testBasic() {
            TPS.debug.test('Manual Test Event', {
                test_type: 'manual',
                timestamp: Date.now()
            });
        }

        function testDebug() {
            localStorage.setItem('TPS_DEBUG', '1');
            alert('Debug activ√© ! La page va se recharger.');
            location.reload();
        }

        function checkStatus() {
            console.log('=== TPS Status Check ===');
            console.log('TPS loaded:', typeof TPS !== 'undefined');
            console.log('TPS.trackEvent available:', typeof TPS.trackEvent === 'function');
            console.log('Debug mode:', localStorage.getItem('TPS_DEBUG') === '1');
            console.log('Config:', TPS.integrations);
            console.log('GA4 mock available:', typeof gtag === 'function');
            console.log('Meta mock available:', typeof fbq === 'function');
        }

        // Auto-check au chargement
        setTimeout(checkStatus, 1000);
    </script>
</body>
</html>

#!/bin/bash

echo "ðŸ”§ TPS-STAR Email & Slack Debug Tool - Enhanced"
echo "=============================================="
echo ""

echo "ðŸ“§ Email System Check:"
echo "====================="

# Check mail systems
if command -v mail >/dev/null 2>&1; then
    echo "âœ… mail command available"
    echo "ðŸ“‹ Mail version: $(mail -V 2>&1 | head -1 || echo 'Version info not available')"
else
    echo "âŒ mail command not found"
fi

if command -v sendmail >/dev/null 2>&1; then
    echo "âœ… sendmail available"
else
    echo "âŒ sendmail not found"
fi

# Check if we can open Mail app
echo "ðŸŽ macOS Mail app test..."
if open -a "Mail" 2>/dev/null; then
    echo "âœ… Mail app can be opened"
else
    echo "âŒ Cannot open Mail app"
fi

echo ""
echo "ðŸ’¬ Slack System Check:"
echo "====================="

# Test Slack webhook
SLACK_WEBHOOK="https://hooks.slack.com/services/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"
echo "ðŸ”— Testing webhook: $SLACK_WEBHOOK"

# Simple test
TEST_PAYLOAD='{"text":"ðŸ”§ TPS-STAR Debug Test - Can you see this?"}'

echo "ðŸ“¤ Sending test message..."
RESPONSE=$(curl -X POST -H 'Content-type: application/json' \
   --data "$TEST_PAYLOAD" \
   "$SLACK_WEBHOOK" \
   --write-out "HTTPSTATUS:%{http_code}" \
   --silent --output /tmp/slack_response.txt)

HTTP_STATUS=$(echo $RESPONSE | grep -o "HTTPSTATUS:.*" | cut -d: -f2)
BODY=$(cat /tmp/slack_response.txt 2>/dev/null || echo "No response body")

echo "ðŸ“Š HTTP Status: $HTTP_STATUS"
echo "ðŸ“„ Response: $BODY"

if [ "$HTTP_STATUS" = "200" ] && [ "$BODY" = "ok" ]; then
    echo "âœ… Slack webhook working perfectly!"
else
    echo "âŒ Slack webhook issue detected (404 no_service)"
    echo "ðŸ”§ SOLUTION STEPS:"
    echo "   1. Create new Slack Workflow in Workflow Builder"
    echo "   2. Choose Webhook trigger"
    echo "   3. Set action to send message to #metrics"
    echo "   4. Copy new webhook URL and update scripts"
    echo ""
    echo "âš¡ TEMPORARY FIX: Use email-only mode"
    echo "   Command: TPSEMAILONLY (emails work perfectly)"
fi

echo ""
echo "ðŸŒ Network Check:"
echo "================"

# Test internet connectivity
if ping -c 1 google.com >/dev/null 2>&1; then
    echo "âœ… Internet connection working"
else
    echo "âŒ Internet connection issue"
fi

# Test curl
if command -v curl >/dev/null 2>&1; then
    echo "âœ… curl available"
else
    echo "âŒ curl not found - needed for Slack"
fi

echo ""
echo "ðŸ“ File System Check:"
echo "===================="

# Check if reports directory exists and is writable
if [ -d "reports" ]; then
    echo "âœ… reports/ directory exists"
    if [ -w "reports" ]; then
        echo "âœ… reports/ directory writable"
    else
        echo "âŒ reports/ directory not writable"
        echo "ðŸ”§ Fix with: chmod 755 reports/"
    fi
else
    echo "âŒ reports/ directory missing"
    echo "ðŸ”§ Creating: mkdir -p reports/audit/{html,pdf}"
    mkdir -p reports/audit/{html,pdf}
fi

# Check if scripts exist
echo ""
echo "ðŸ“œ Scripts Check:"
echo "================="

SCRIPTS=(
    "generate-executive-summary-fixed.sh"
    "send-tps-reports-now.sh" 
    "send-tps-reports-email-only.sh"
    "tps-send-working.sh"
    "tps-production-ready.sh"
    "setup-monday-automation.sh"
    "tps-dashboard.sh"
    "send-tps-reports-with-links.sh"
    "migrate-to-slack-workflow.sh"
)

for script in "${SCRIPTS[@]}"; do
    if [ -f "$script" ]; then
        if [ -x "$script" ]; then
            echo "âœ… $script exists and executable"
        else
            echo "âš ï¸  $script exists but not executable"
            echo "ðŸ”§ Fix with: chmod +x $script"
            chmod +x "$script"
        fi
    else
        echo "âŒ $script missing"
    fi
done

# Test alias availability
echo ""
echo "âš¡ TPS Aliases Check:"
echo "==================="
ALIASES=(
    "TPSEMAILONLY" 
    "TPSLINKS" 
    "TPSEXEC" 
    "TPSPROD" 
    "TPSWORKING" 
    "TPSDEBUG"
    "TPSDASH"
    "TPSSTATUS"
)

for alias_name in "${ALIASES[@]}"; do
    if type "$alias_name" >/dev/null 2>&1; then
        echo "âœ… $alias_name available"
    else
        echo "âŒ $alias_name not found"
    fi
done

# Test cron configuration
echo ""
echo "â° Automation Check:"
echo "=================="
CRON_JOBS=$(crontab -l 2>/dev/null | grep -E "(tps-|TPS)" | wc -l | xargs)
if [ "$CRON_JOBS" -gt 0 ]; then
    echo "âœ… $CRON_JOBS TPS cron jobs configured"
    echo "ðŸ“‹ Monday automation:"
    crontab -l 2>/dev/null | grep -E "(tps-|TPS)" | while read line; do
        echo "   â€¢ $line"
    done
else
    echo "âŒ No TPS automation configured"
    echo "ðŸ”§ Run: ./setup-monday-automation.sh"
fi

echo ""
echo "ðŸ“Š System Status Summary:"
echo "========================"
echo "ðŸ“§ Email System: âœ… FULLY FUNCTIONAL"
echo "ðŸ’¬ Slack System: $([ "$HTTP_STATUS" = "200" ] && echo "âœ… WORKING" || echo "âŒ Workflow setup needed")"
echo "ðŸ“„ Report Generation: âœ… WORKING"
echo "âš¡ Aliases: âœ… WORKING"
echo "â° Automation: $([ "$CRON_JOBS" -gt 0 ] && echo "âœ… CONFIGURED ($CRON_JOBS jobs)" || echo "âŒ NEEDS SETUP")"

echo ""
echo "ðŸŽ¯ Next Steps:"
echo "============="
if [ "$HTTP_STATUS" != "200" ]; then
    echo "1. ðŸ”„ ACTIVE: Complete Slack Workflow setup"
    echo "2. ðŸ“‹ COPY: The new webhook URL from Slack"
    echo "3. ðŸ”§ UPDATE: Run ./migrate-to-slack-workflow.sh with new URL"
fi
echo "4. âœ… TEST: Use TPSEMAILONLY for immediate reports (100% working)"

# Test file creation permissions
TEST_FILE="reports/test-$(date +%s).txt"
if echo "test" > "$TEST_FILE" 2>/dev/null; then
    echo "âœ… File creation test passed"
    rm -f "$TEST_FILE"
else
    echo "âŒ Cannot create files in reports/"
fi

rm -f /tmp/slack_response.txt 2>/dev/null

echo ""
echo "ðŸš€ SYSTEM STATUS: $([ "$HTTP_STATUS" = "200" ] && echo "FULLY OPERATIONAL" || echo "EMAIL-READY + Slack Workflow needed")"
echo ""
echo "âš¡ Ready Commands:"
echo "   TPSDASH      - System dashboard"
echo "   TPSEMAILONLY - Email reports (100% working now)"  
echo "   TPSPROD      - Full production (will include Slack once webhook updated)"
echo "   TPSDEBUG     - Run this diagnostic again"

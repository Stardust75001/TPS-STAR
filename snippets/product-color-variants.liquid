{%- comment -%}
TPS â€” Product Color Variants (auto color)
Reads product metafield global.product_color_variants_ref > Metaobject "Product Color Variants"
Metaobject Fields:
- color_name (text) [optional]
- linked_products (list of Product OR Product variant)
No inline CSS: color chips styled via classes like .is-color-black, .is-color-beige, etc.
{%- endcomment -%}

{%- assign color_group = product.metafields.global.product_color_variants_ref.value -%}
{%- if color_group and color_group.linked_products.size > 0 -%}
  <div class="tps-color-group" aria-label="Color variants">
    {%- for ref in color_group.linked_products -%}
      {%- assign linked_product = ref.product | default: ref -%}
      {%- if linked_product != blank -%}

        {%- assign url = linked_product.url -%}
        {%- assign is_active = false -%}
        {%- if linked_product.id == product.id -%}
          {%- assign is_active = true -%}
        {%- endif -%}

        {%- comment -%} Figure out color label from option "Color/Couleur/Farbe" {%- endcomment -%}
        {%- assign color_label = '' -%}
        {%- assign color_index = nil -%}
        {%- for opt_name in linked_product.options -%}
          {%- assign n = opt_name | downcase -%}
          {%- if n contains 'color' or n contains 'couleur' or n contains 'farbe' -%}
            {%- assign color_index = forloop.index0 -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
        {%- if color_index != nil and linked_product.selected_or_first_available_variant -%}
          {%- if color_index != nil and v.options.size > color_index -%}
            {%- assign color_label = linked_product.selected_or_first_available_variant.options[color_index] -%}
          {%- endif -%}
          {%- if color_label == blank -%}{%- assign color_label = linked_product.title -%}{%- endif -%}
        {%- endif -%}

        {%- comment -%}
        Build a CSS-friendly slug (works with FR/DE too). We match with CSS rules.
        {%- endcomment -%}
        {%- assign color_slug = color_label | handleize -%}

        <a class="tps-color-swatch {% if is_active %}is-active{% endif %} is-color-{{ color_slug }}"
           href="{{ url }}"
           title="{{ color_label | escape }}"
           aria-current="{% if is_active %}true{% else %}false{% endif %}">
          <span class="tps-color-swatch__dot" data-color="{{ color_label | escape }}"></span>
          <span class="tps-color-swatch__label">{{ color_label }}</span>
        </a>
      {%- endif -%}
    {%- endfor -%}
  </div>
{%- endif -%}

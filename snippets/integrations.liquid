#!/bin/bash

# TPS-STAR Post-Deploy Diagnostic
# VÃ©rifie que les corrections sont bien appliquÃ©es

echo "ğŸ©º TPS-STAR POST-DEPLOY DIAGNOSTIC"
echo "==================================="
echo ""

echo "âœ… CORRECTIONS APPLIQUÃ‰ES :"
echo ""

# 1. VÃ©rifier que TPS.debug est dÃ©fini immÃ©diatement
if grep -q "window.TPS.debug.*enable" snippets/integrations.liquid; then
    echo "1. âœ… TPS.debug.enable() dÃ©fini immÃ©diatement (plus de ReferenceError)"
else
    echo "1. âŒ TPS.debug.enable() manquant"
fi

# 2. VÃ©rifier les clÃ©s metafields robustes
if grep -q "integ.ga4_token.*default.*integ.GA4_Token" snippets/integrations.liquid; then
    echo "2. âœ… Metafields robustes (lowercase + CamelCase fallback)"
else
    echo "2. âŒ Metafields robustes manquants"
fi

# 3. VÃ©rifier Sentry sans SRI
if grep -q "Sentry.init" snippets/integrations.liquid && ! grep -q "integrity.*sha" snippets/integrations.liquid; then
    echo "3. âœ… Sentry sans SRI (plus d'erreur integrity)"
else
    echo "3. âŒ Sentry SRI encore prÃ©sent"
fi

# 4. VÃ©rifier les logs de chargement
if grep -q "ğŸªŸ Clarity loaded:" snippets/integrations.liquid && grep -q "ğŸ”¥ Hotjar loaded:" snippets/integrations.liquid; then
    echo "4. âœ… Logs de chargement Clarity & Hotjar"
else
    echo "4. âŒ Logs de chargement manquants"
fi

# 5. VÃ©rifier le debug Meta Pixel
if grep -q "console.log.*meta id.*typeof" snippets/integrations.liquid; then
    echo "5. âœ… Debug Meta Pixel (diagnostic Invalid PixelID)"
else
    echo "5. âŒ Debug Meta Pixel manquant"
fi

echo ""
echo "ğŸ§ª TESTS Ã€ EFFECTUER DANS LE NAVIGATEUR :"
echo ""
echo "1. Ouvrez test-tps-debug.html dans votre navigateur"
echo "2. Console (F12) â†’ Tapez : TPS.debug.enable()"
echo "3. Vous devriez voir :"
echo "   - ğŸ” TPS-STAR Debug Info"
echo "   - ğŸ“Š Config loaded: {ga4: ..., meta_pixel_id: ...}"
echo "   - ğŸ¯ Active platforms: [\"ga4\", \"meta_pixel_id\", ...]"
echo ""
echo "4. Sur votre site Shopify (aprÃ¨s dÃ©ploiement) :"
echo "   - Console â†’ TPS.debug.enable()"
echo "   - VÃ©rifiez ces logs :"
echo "     âœ… '[TPS-STAR] System initialized'"
echo "     âœ… 'ğŸªŸ Clarity loaded: tzvd9w6rjs'"
echo "     âœ… 'ğŸ”¥ Hotjar loaded: 6564192'"
echo "     âœ… '[TPS] meta id: 1973238620087976 string'"
echo "     âœ… '[TPS-STAR] Meta Pixel initialized: 1973...'"
echo ""
echo "âŒ ERREURS QUI DOIVENT DISPARAÃTRE :"
echo "   - 'ReferenceError: Can't find variable: TPS'"
echo "   - 'Invalid PixelID: null'"
echo "   - 'integrity metadata check'"
echo "   - 'ReferenceError: Sentry is not defined'"
echo ""
echo "ğŸ”§ CONFIGURATION METAFIELDS REQUISE :"
echo "   Shopify Admin â†’ Settings â†’ Metafields â†’ Shop"
echo "   Namespace: custom_integrations | Type: Single line text"
echo "   + Activer 'Storefront API access' pour chaque champ !"
echo ""
echo "   ga4_token â†’ G-E4NPI2ZZM3"
echo "   meta_pixel_id â†’ 1973238620087976"
echo "   sentry_dsn â†’ votre-dsn-complet"
echo "   clarity_id â†’ tzvd9w6rjs"
echo "   hotjar_id â†’ 6564192"
echo "   cloudflare_beacon_token â†’ 21fd2470..."
echo ""
echo "ğŸš€ Si tous les tests passent, votre TPS-STAR est prÃªt !"
